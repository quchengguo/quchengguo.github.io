<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>quchengguo</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="quchengguo"><meta name="msapplication-TileImage" content="/img/mylogo.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="quchengguo"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="quchengguo"><meta property="og:url" content="https://quchengguo.github.io/"><meta property="og:site_name" content="quchengguo"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://quchengguo.github.io/img/og_image.png"><meta property="article:author" content="quchengguo"><meta property="article:tag" content="人文 编程"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://quchengguo.github.io"},"headline":"quchengguo","image":["https://quchengguo.github.io/img/og_image.png"],"author":{"@type":"Person","name":"quchengguo"},"publisher":{"@type":"Organization","name":"quchengguo","logo":{"@type":"ImageObject","url":{"text":"qcg Blog"}}},"description":""}</script><link rel="icon" href="/img/mylogo.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">qcg Blog</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item is-active" href="/">首页</a><a class="navbar-item" href="/archives">时间轴</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a></div><div class="navbar-end"></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2024-07-16T14:05:51.000Z" title="2024/7/16 下午10:05:51">2024-07-16</time>发表</span><span class="level-item"><time dateTime="2024-07-16T14:10:50.917Z" title="2024/7/16 下午10:10:50">2024-07-16</time>更新</span><span class="level-item">1 小时读完 (大约7940个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2024/07/16/%E5%8E%86%E5%8F%B2%E7%9A%84%E5%9E%83%E5%9C%BE%E6%97%B6%E9%97%B4/">历史的垃圾时间</a></h1><div class="content"><p>1368年，朱元璋创建明朝、立八股文；但丁《神曲》诞生已60年，薄伽丘写完了《十日谈》，西欧人开始觉醒。</p>
<p>1380年，明太祖诛杀胡惟庸、废相权；英国大宪章发布逾170年，已确立私有财产和人身自由不可侵犯的原则，贵族势力崛起。</p>
<p>1587年，万历十五年，宦官得宠，权势正盛；莎士比亚开启演艺与创作生涯，8年后写出《罗密欧与朱丽叶》。</p>
<p>1643年，大清顺治帝继位，多尔衮摄政；牛顿降生。“天不生牛顿，万古如长夜”，1666年，牛顿回老家躲避瘟疫创作了微积分学、经典力学、光学和天文学理论，是为牛顿奇迹年，此时满清第一大文字狱《明史》案刚结案。</p>
<p>1689年，康熙八年，康熙擒拿鳌拜，亲理朝政；洛克发表《政府论》，批判君权神授、王位世袭，提出公民政府，同时英国议会通过了权利法案，限制王权。</p>
<p>1776年，乾隆谕示衙署大规模删销书籍；同年，亚当·斯密发表《国富论》，北美发布《独立宣言》，瓦特蒸汽机投产，堪称人类奇迹年。</p>
<p>14-15世纪，在人类历史的关键路口，朱元璋建立的大明王朝将华夏推入“历史的垃圾时间”。从此，东方进入大分流时代。</p>
<p>何为“历史的垃圾时间”？历史的垃圾时间，是文化的悠长假期，还是文化的罗刹海市？如何度过“历史的垃圾时间”？</p>
<p>本文以“历史的垃圾时间”为切入点思考国家现代化的困境。</p>
<h1 id="本文逻辑"><a href="#本文逻辑" class="headerlink" title="本文逻辑"></a>本文逻辑</h1><p>一、历史的垃圾时间</p>
<p>二、文化的罗刹海市</p>
<p>三、个人的临终关怀</p>
<h2 id="一、历史的垃圾时间"><a href="#一、历史的垃圾时间" class="headerlink" title="一、历史的垃圾时间"></a>一、历史的垃圾时间</h2><p>很多历史研究者认为，苏联的崩溃是从1979年入侵阿富汗开始的。资深媒体人胡文辉将苏联从1979年到1991年这段时间定义为“历史的垃圾时间”，说戈尔巴乔夫只是让这段垃圾时间早点结束罢了【1】。</p>
<p>胡文辉还认为，历史的垃圾时间，绝不止适用于俄罗斯的历史，绝不止适用于当代史。比如，公元前 770年西周覆灭、平王东迁洛阳后属于周朝的垃圾时间；249年高平陵之变后属于曹魏的垃圾时间；878年黄巢之乱后属于唐代的垃圾时间，1630年崇祯处死袁崇焕后属于明代的垃圾时间，1600年关原之战后属于丰臣政权的垃圾时间。</p>
<p>历史的垃圾时间，感觉像经验主义的说辞，此概念并不严谨，且有事后诸葛亮之嫌。</p>
<p>“唐亡于黄巢，而祸于桂林”，陈寅恪借用了宋祈在《新唐书·南诏传》的观点，认为黄巢之乱破坏了东南诸道财富之区，断绝了南北运输之汴路，李唐因此丧失了南方的经济力量。如果还要往前追溯，那就是因南诏侵边而引发的庞勋之乱——868年庞勋率800名徐州戍卒在桂林发动兵变。</p>
<p>朱明的垃圾时间从什么开始呢？黄仁宇认为是“万历十五年”：“1587年，是为万历十五年，丁亥次岁，表面上似乎是四海升平，无事可记，实际上我们的大明帝国却已经走到了它发展的尽头”。</p>
<p>不过，胡文辉反对黄仁宇这种“大历史观”。他认为，如果大明亡于万历十五年，那么中国历史也结束了。满清三百年都是历史的垃圾时间。胡文辉将1630年崇祯自毁长城到煤山自尽这14年时间界定为明朝的垃圾时间。</p>
<p>按照历史经验方法论，历史的垃圾时间存在不少分歧和争论。它隐含着历史必然性，这本身是一个富有争议的观点。若以结果论历史必然性，容易陷入循环论证。</p>
<p>通常，我们说“比赛进入垃圾时间”，它最起码包含两层意思：一是确定的倒计时；二是失败的结局是大概率事件。我们如果身处那个时代，又如何知晓这段历史何时结束、下一段历史从哪里开启？更重要的是，“垃圾时间”是相对大概率的失败者来说的，对于潜在的胜出者而言，那是“一元复始”。</p>
<p>不过，历史的垃圾时间还是一个有趣、有价值的说辞。而且，从逻辑上来看——非历史经验主义，它还是一个可靠的概念。我们可以从经济学的逻辑和政治学的逻辑分别推演历史的垃圾时间。</p>
<p>早在1920年，米塞斯就发表了一篇题为《社会主义制度下的经济计算》的文章【2】，他从经济计算的角度否定了帕累托提出的社会主义计划经济以及集中配置资源的可能性，而这个时候苏联尚未成立。换言之，苏联尚未诞生之前，米塞斯就通过逻辑推理预言这种经济体必然失败。按照米塞斯的逻辑，苏联从1922年诞生开始便进入垃圾时间。</p>
<p>所以，从经济学的逻辑来看，当某段历史正处于违背经济规律、个人又无力改变、且必然走向失败的阶段，我们将其定义为“历史的垃圾时间”。</p>
<p>苏联的崩溃是米塞斯推演的计划经济体制的失败，也是苏联权力高度集中的民族国家制度的失败。民族国家失败的比比皆是，他们失败的共同原因是没有成为民主国家，即民族国家内部的权力未能合法化、未能落实到国民手上。</p>
<p>“王在法下”，国家权力从统治者过渡到国民，且以宪法约束之，这是古今之变，亦是国家现代化的关键难题。这就是政治学的逻辑。</p>
<p>孔飞力根据英国光荣革命的经验，构建了一套“政治参与、政治竞争与政治控制”的逻辑【3】。他认为，随着经济进步而扩大的精英阶层在多大程度上参与政治，关系到国家现代化的进程与风险。就在朱家明朝灭亡后，英国贵族高度参与政治，制衡皇权，以和平改良道路通往了现代文明。同期，法国路易十四大幅度加强皇权，削弱贵族权力，权力过度集中，最后政治结构失去平衡，路易十六被送上断头台。</p>
<p>钱穆在其《中国历代政治得失》一书中细数历代政治权力结构的变迁。他认为，将中国古代王朝定义为中央集权并不准确，实际上历代间极多变迁。“倘使我们说，中国传统政治是专制的，政府由一个皇帝来独裁，这一说法，用来讲明清两代是可以的。若论汉、唐、宋诸代，中央政府的组织，皇权相权是划分的，其间比重纵有不同，但总不能说一切由皇帝专制。【4】”</p>
<p>钱穆从人事和制度两个维度剖析皇权和相权的关系，认为明太祖废相权、集皇权，导致政治权力高度集中。明太祖诛杀胡惟庸、废止宰相，要求子孙永远不再立宰相。不仅如此，明朝朱家废掉中书省、门下省，只保留尚书省；而且尚书省没有长官，由六部负责，叫六部尚书，官衔二品。六部尚书、九卿加上武官大都督，平列一线，由皇帝全权管理。皇帝设私人秘书处，任用内阁大学士，帮助其统管一切。有人说，大学士实际上充当了宰相，但权力结构发生了根本性变化，大学士掌控的行政权对皇权负责。</p>
<p>后来，清朝爱新觉罗氏基本上沿用了这套政治体制。在孔飞力看来，魏源提出了这一根本性的问题：国家应如何通过让文人们更为热诚地承担责任以及更为广泛地参与政治，从而在国家变得更加富有生气的同时，也使得威权统治得到加强。魏源的继承者冯桂芬走得更远，他在《公黜陟议》中主张应当通过官员选举来扩大政治参与。他引用孔子的话“举直错诸枉，则民服”，“有请升缺，用其举多者”【5】。</p>
<p>在时代变迁中，政治权力结构是幂律化还是橄榄型走势，决定着这个国家的前途——国家现代化道路是和平的改革的，还是暴力的曲折的。明代，正是世界近代文明开启之时代，相权废止关闭了国家现代化的大门。由此，进入历史的垃圾时间。</p>
<h2 id="二、文化的罗刹海市"><a href="#二、文化的罗刹海市" class="headerlink" title="二、文化的罗刹海市"></a>二、文化的罗刹海市</h2><p>历史有垃圾时间，但个人没有。</p>
<p>个人该如何度过历史的垃圾时间？</p>
<p>胡文辉认为，历史之大是一回事，个人之微又是另一回事。在历史的垃圾时间里，个人在政治上固然束手无策，但在生活上，在文化上，是不妨继续放飞自我的【1】。</p>
<p>所谓“天下有道则见，无道则隐”，隐可以理解为躺平，是对历史的垃圾时间的一种拒绝、一种规避。胡文辉建议，一旦遭遇历史的垃圾时间，就把它当作文化的悠长假期好了。</p>
<p>“在大唐的垃圾时间里，有失意的皮日休，落第的陆龟蒙、罗隐，远走西蜀的韦庄，逃避后梁的韩偓，都各自拥有了他们的悠长假期，并焕发出异样的文化光彩【1】”。在胡文辉看来，当进入历史的垃圾时间时，又会分裂出另一个历史的平行宇宙，即政治上最阴暗的世界和文化上最华美的世界。</p>
<p>在明清的垃圾时间里，才子佳人纵情秦淮，孔尚任写下了侯方域和李香君的悲欢离合，著《桃花扇》，冒襄写下了他与董小宛的缠绵悱恻，著《影梅庵忆语》。还有吴伟业创作了《琵琶行》、《鸳湖曲》、《琴河感旧》。</p>
<p>“任凭一片风雨气，来作神舟袖手人”。或许，胡文辉想要表达的感怀，并不是豁达与浪漫主义，而是无奈与买醉情绪。</p>
<p>历史的垃圾时间，未必是文化的悠长假期，更可能是文化的罗刹海市。</p>
<p>在历史的垃圾时间里，从来都没有星河璀璨，只有牛鬼蛇神。在文化的罗刹海市中，戈培尔式喉舌、盛世美颜家、马屁精、应声虫，群魔乱舞，狂躁的无知者、搭便车者、沉默的大多数以及一群装作人畜无害样子的帮凶——汉娜·阿伦特斥之无思想、无人格、无责任的“平庸之恶”【7】，层林尽染，共同演绎出一副“那马户不知道他是一头驴，那又鸟不知道他是一只鸡”的海市蜃楼。蒲松龄谓之“聊斋”。</p>
<p>大树底下，寸草不生；王权集中，万马齐喑。从米塞斯到孔飞力、钱穆，我们发现，经济与政治的权力集中制造了历史的垃圾时间，而集权又是文化的天敌。</p>
<p>每当历史进入垃圾时间，最先倒下的永远是文化人、思想者。每一轮文化浩劫就像历史的复读机：从尖锐的批评声消失，到沉默将被认为居心叵测，然后是赞美不够卖力也是一种罪，最后只留下一种声音：谎言。</p>
<p>而且，王权越集中，对意识形态的控制就越疯狂，对异见者的打击就越极端。</p>
<p>满清入关后对汉族知识分子狐疑不决，大兴文字狱，案件大约160-170起，比其他朝代文字狱总数还要多。胡奇光在其《中国文祸史》中指出：“（清朝文字狱）持续时间之长，文网之密，案件之多，打击面之广，罗织罪名之阴毒，手段之狠，都是超越前代的。【6】”</p>
<p>顺治十八年的《明史》案是满清文字狱的第一大案。当时，浙江湖州富户庄廷鑨购买了明朝首辅朱国桢未完成的《明史》，然后招揽名士赠润删节，补写崇祯朝及南明史事，修成《明史辑略》。结果被归安知县吴之荣告发，酿成大祸。尽管此时庄廷鑨已死，仍被掘墓刨棺，枭首碎骨，尸体悬吊杭州城北关城墙上，示众三个月。名士编辑、刻印买卖等221人获罪，重辟70余人，凌迟18人。</p>
<p>为何王权执着于意识形态控制？</p>
<p>我们可以用赵鼎新的政权合法性理论来解释。赵鼎新认为，政权合法性来自三个方面：意识形态的合法性、程序的合法性和绩效的合法性，分别对应的价值理性、形式理性和工具理性【8】。按照现代国家的标准，历代王权的程序合法性不足，君王不得不诉诸于意识形态的合法性，对意识形态的控制到达无以复加的地步。</p>
<p>古代东方的世俗思想在春秋战国时期“过度”成熟，压倒了自然宗教思想。统治阶层宣扬君权神授来维护其王权来源的合法性，却试图用世俗思想维护其王权万世永固。</p>
<p>所谓百花齐放的时代，不过是统治思想百家争斗、精英争当帝师的时代。秦，法家得势，焚书坑儒。汉，儒家崛起，罢黜百家。孔子讲克己复礼，孟子还说民贵君轻，董仲舒就列三纲五常，朱熹集大成，“穷天理，明人伦，讲圣言，通事故”，明清帝师大儒登峰造极。</p>
<p>不过，世俗思想无法像宗教一样解决灵魂归宿问题，让民众绝对服从王权。神为何授君权给嬴姓赵氏？我家为何世代为奴？“王侯将相有种乎”揭开了意识形态包裹的皇帝的新装，于是，两千年来革命不止，王朝更替。</p>
<p>古代欧洲诸国王权的意识形态合法性来自神权，而非世俗思想。《圣经·罗马书》写道：“在上有权柄的，人人当顺服他，因为没有权柄不是出于神的。凡掌权的都是神所命的。所以，抗拒掌权的就是抗拒神的命”。三大宗教均有一套说服信徒归顺王权统治的意识形态，即信徒永生。上帝说，人天生下来就是有罪的，耶稣降临、被钉上十字架，是为了洗脱世人的罪。信徒不谋今生求永生——“你们若不重生，就不能进上帝的国”，“我实实在在告诉你们，信的人有永生”。</p>
<p>欧洲君主借助神解决了意识形态合法性问题，其王权世代延绵，上千年未见革命，意识形态拿捏得死死的。</p>
<p>为什么近代思想发迹于欧洲？</p>
<p>神权与王权合谋，但亦相互制衡，欧洲始终没有出现一股绝对的权力。而且，神权与王权，常常你争我斗，厮杀不止。这反而给民间留下一些空间。</p>
<p>14世纪中期席卷大半个欧洲的黑死病击溃了中世纪的统治。人开始觉醒，开始质疑神，接着马丁·路德宗教改革，掌握《圣经》的解释权。韦伯认为，新教为资本主义提供了一种心里驱动力和道德能量，“资本主义愈加放手，这一状况亦愈加明显【9】。”</p>
<p>当神权衰落，王权试图称霸。15世纪末开始，奥地利哈布斯堡王室和法国瓦卢瓦王室为了抢夺意大利众多城邦而大打出手，英格兰、西班牙、神圣罗马帝国等众多欧洲王室卷入其中，史称意大利战争。这场战争打来打去打了60多年，结果不仅王权没有增强，还激活了民间力量。</p>
<p>诺斯在其《西方世界的兴起》中就讲到了这场战争【10】。当时的国王、城邦要打仗，没有足够的财力和税收猎取的能力，只能向当地商人借钱，这直接催生了现代金融——政府债券。诺斯强调，那些欠钱不还的西班牙、猎税能力强的法国，成为了失败的国家，而民间商业力量的勃兴成为了国家的历史指针。</p>
<p>当地望族美第奇家族参与了意大利战争，美第奇帮助神圣罗马帝国对抗法国，以获取其在佛罗伦萨统治地位。在之后的200年里，这个银行家族成为了佛罗伦萨无冕之主。</p>
<p>美第奇家族大力资助了达·芬奇、拉菲尔、米开朗基罗等开创等文艺复兴，没有美第奇家族，文艺复兴肯定不是这个样子。文艺复兴主张人文主义，启蒙运动宣扬人权主义，从此欧洲走出蒙昧时代。</p>
<p>15世纪，朱明时期，东西方开始进入彭慕兰所说的大分流时代。</p>
<p>康乾时期，爱新觉罗王室大规模编纂《皇朝文献通考》《大清会典》《四库全书》。同期，孟德斯鸠发表《论法的精神》，提出三权分立；卢梭发表《社会契约论》，提出人民主权；康德发表《纯粹理性批判》；狄德罗编撰百科全书。他们解决了国家现代化中的关键问题。</p>
<p>尽管在历史的垃圾时间中，也涌现过王守仁、李贽、王夫之、黄宗羲、顾炎武等进步思想家，但无法与启蒙时代的星辰大海相提并论。</p>
<p>那是另一个时代了。</p>
<h2 id="三、个人的临终关怀"><a href="#三、个人的临终关怀" class="headerlink" title="三、个人的临终关怀"></a>三、个人的临终关怀</h2><p>复盘人类千年史给人的感觉是，15世纪之后，人类的天灵盖突然打开了。用康德的话来说就是“解除人类自己给自己戴上的心灵枷锁”。</p>
<p>麦迪森在其《世界经济千年史》通过核算发现，西欧在公元第一个千年里的人均GDP基本没有增长，在450国际元以下；1000年到1500年才有起色，18世纪后旱地拔葱。中国第一个千年的人均GDP略高于西欧，但也是千年停滞；第二个千年前900年亦如此，最近百年才奋起直追【11】。</p>
<p>若按大历史观，人类在数千年中都处于“历史的垃圾时间”，生产力没有任何提高，资产没有增值，经历一场漫长寒冬，犹如地球远古冰河时期。每个人、每代人的努力似乎都“白费”，处境千年不变，有时甚至更糟，陷入掉入了一种陷阱。这种陷阱叫马尔萨斯陷阱。</p>
<p>在马尔萨斯陷阱中，人越努力、越内卷，越陷越深。由于关键问题没有解决，技术水平极低、且几无增量，人越努力，生得孩子越多，粮食越紧缺，最终陷入饥荒、瘟疫。为了逃避饥荒和瘟疫，迁移、拓荒、抢夺，争夺存量，相互战争。《约翰启示录》那四匹苍白的马——瘟疫、战争、饥馑、死亡，闯入人间，劫掠生灵。</p>
<p>在历史的垃圾时间里，因为方向错误，努力只会加速终结。</p>
<p>钱穆在其《中国历代政治得失》讲了明朝朱家子孙为何不上朝的原因【4】。他说，太祖废宰相后，所有行政大权、事务与压力落到皇帝身上，而朱家子孙深宫养大，没有太祖过人的精力处理如此庞大的朝政，只能让秘书即大学士代之。一天不上朝、三天不问政，自然跟不上、也不愿跟，最后在位不在朝、代代不上朝。</p>
<p>等崇祯接手时已是江山破败、民生凋敝、边防危急。不过，崇祯不像朱家先辈一样浑浑噩噩，而是勤于政事，夙兴夜寐，以图中兴，就连自杀前两天还在上朝。但是，崇祯的勤政反而加速终结了明朝的终结。崇祯凌迟处镇守辽东边关大将袁崇焕，结果自废武功，内乱外患并起。</p>
<p>要说勤政，没有哪个朝代比得上清朝爱新觉罗氏。爱新觉罗氏皇帝，个个勤于朝政，文韬武略。但是，最怕皇帝有野心。皇帝南征北伐，定然横征暴敛；杀伐决断，必然血流成河；口壅若川，自然万马齐喑。</p>
<p>皇帝大开大合，大臣、官僚、地主、农民、商人、奴隶内卷愈深，所有的努力不过是加剧彼此厮杀，流民逃荒，成人杀婴，老人入林。唯一有价值的言辞，不过是超度亡灵的悲歌。</p>
<p>崇祯在煤山自杀时只有太监王承恩陪着他，死前在衣服上写到：朕凉德藐躬，上干天咎，然皆诸臣误朕。朕死无面目见祖宗，自去冠冕，以发覆面。任贼分裂，无伤百姓一人。王承恩在崇祯人生的最后一刻还提供了情绪价值，衣服上的推脱之词更像是写给自己的临终关怀。</p>
<p>人类的历史演进具有戏剧性、跳跃性。15世纪之后，人类灰暗的阴霾突然就消失了，这一恐怖的千年黑夜似乎从来就没有出现过。哪怕是最底层的人只要努力，其处境就可获得极大的改善。</p>
<p>茨威格在其回忆录《昨日的世界》描述了欧洲这种激动人心的变化：“维也纳、米兰、巴黎、伦敦、阿姆斯特丹这样一些城市，我只要每去一次就会感到惊讶和欣喜。那里的街道越来越宽阔、越来越漂亮，公共建筑越来越有气派，店铺越来越豪华、越来越美观。人们从各种食物中都能感觉到财富在增长、在扩大……谁敢作敢为，谁就能获得成功。【12】”</p>
<p>在国家现代化的路上，欧洲以启山林，美洲亚洲纷纷跟进。美国走得是福泽谕吉的道路，韩国及多数转轨国家走得是弗里德曼的道路，即由经济自由促进政治自由。不过转轨成功的国家并不多，原因是政治上如何跨越格林尼治时间。一旦政治上未越过，经济上容易倒退，历史又进入一段垃圾时间。</p>
<p>其实，机会往往就在一两代人手上。</p>
<p>诺斯在《西方世界的兴起》中就讲到，英国、荷兰的成功在于，征税权被限制的王室不得不鼓励贸易和市场，促进了有产者的成长【10】。而随着私人财富的增加，有产者开始参与政治权力，通过建立一套宪政体系来保护私人财富，最终完成国家现代化。</p>
<p>换言之，因贸易和市场兴起的一两代人是幸运的人，也是国家现代化的关键人物。他们有财产、有知识、有影响力，有人甚至担任官员、议员、律师。最重要的是，他们是王室赖以生存的经济力量，是唯一一股能够与王权博弈、且以和平方式推动国家进入现代化的力量。实际上，这一两代社会精英就是孔飞力渴望的政治参与的中坚力量。</p>
<p>1979年，韩国统治者朴正熙被部下刺杀，在“汉江奇迹”中崛起的40后、50后开始挑战军政府，军政府血腥镇压，这两代人勇敢斗争，最终借助1988年汉城奥运会帮助韩国越过格林尼治时间。如果那一两代人错失良机、最后失败，那么韩国政治结构就会塌缩成幂律形态，矛盾尖锐，革命不息。</p>
<p>所以，汉江奇迹，即汉江窗口期。对这个国家来说，一旦错过，那就是一百年。</p>
<p>集体行动的困境于，当国家市场程度很低时，机会主义动机非常强烈，“汉江奇迹”那两代人未必愿意充当司机。奥尔森在《集体行动的逻辑》中指出，集体行动的人越多，搭便车者越多【13】。他们就像毛不易《消愁》中写得那样：“自以为是地表演着，伪装着，舞蹈着，疲惫着”。</p>
<p>王缉思说：“在不确定的时代，做一个‘普通的好人’”。嗯，这是一个底线，也是一个不错的说辞。“人生苦短何必念念不忘，一杯敬自由，一杯敬死亡”，买醉创造最大的情绪价值，天亮之后潦草离场，“清醒的人最荒唐”【15】。</p>
<p>胡文辉在文章中用友人赠字、南宋张元干的《瑞鹧鸪·彭德器出示胡邦衡新句次韵》来表达对历史的垃圾时间的感怀：‍</p>
<p>白衣苍狗变浮云，</p>
<p>千古功名一聚尘。</p>
<p>好是悲歌将进酒，</p>
<p>不妨同赋惜余春。</p>
<p>风光全似中原日，</p>
<p>臭味要须我辈人。</p>
<p>雨后飞花知底数，</p>
<p>醉来赢取自由身。</p>
<p>这何尝不是张元干留给北宋遗老的临终关怀？</p>
<p><strong>参考文献</strong></p>
<p>【1】历史的垃圾时间，文化的悠长假期，胡文辉，个人图书馆，2023年9月；</p>
<p>【2】社会主义，路德维希·冯·米瑟斯著，王建民、冯克利、崔树义译，中国社会科学出版社，2008年5月；</p>
<p>【3】中国现代国家的起源，孔飞力著，陈兼、陈之宏译，生活·读书·新知三联书店，2013年10月；</p>
<p>【4】中国历代政治得失，钱穆，生活·读书·新知三联书店，2012年7月；</p>
<p>【5】校邠庐抗议，冯桂芬，上海书店出版社，2002年1月；</p>
<p>【6】中国文祸史，胡奇光，上海人民出版社，2006年10月；</p>
<p>【7】反抗“平庸之恶”，汉娜·阿伦特著，陈联营译，上海人民出版社，2014年4月；</p>
<p>【8】Politics of Legitimacy, Zhao Dingxin,NTU Press,2017.12；</p>
<p>【9】新教伦理与资本主义精神，马克斯·韦伯著，简惠美、康乐译，广西师范大学出版社， 2010年9月；</p>
<p>【10】西方世界的兴起，道格拉斯·诺斯、罗伯特·托马斯著，厉以平、蔡磊译，华夏出版社， 2009年6月；</p>
<p>【11】世界经济千年史，麦迪森著，伍晓鹰、许宪春译，北京大学出版社，2003年11月；</p>
<p>【12】昨日的世界，斯蒂芬·茨威格著，舒昌善译，生活·读书·新知三联书店，2018年6月；</p>
<p>【13】集体行动的逻辑，曼瑟尔·奥尔森，陈郁、郭宇峰、李崇新译，格致出版社，2017年8月；</p>
<p>【14】在不确定的时代，做个一个“普通的好人”，缉思，看理想，2023年11月；</p>
<p>【15】消愁，毛不易，平凡的一天，2018年5月。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-01-04T12:09:54.000Z" title="2023/1/4 下午8:09:54">2023-01-04</time>发表</span><span class="level-item"><time dateTime="2023-01-04T13:10:16.807Z" title="2023/1/4 下午9:10:16">2023-01-04</time>更新</span><span class="level-item">15 分钟读完 (大约2261个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2023/01/04/%E4%BD%A0%E6%98%AF%E7%AC%AC%E5%87%A0%E6%B5%81%E4%BA%BA%E6%89%8D-%E8%B0%A2%E6%98%A5%E9%9C%96/">你是第几流人才-谢春霖</a></h1><div class="content"><h1 id="你是第几流人才"><a href="#你是第几流人才" class="headerlink" title="你是第几流人才"></a>你是第几流人才</h1><p>​    NLP（神经语言程序学）是由理查德班德乐和约翰格林在1976年开创的一门学问，美国前总统克林顿、微软领袖比尔盖茨、大导演斯皮尔伯格等许多世界名人都接受过NLP培训，世界500强企业中的60%采用NLP培训员工。<font color=red>理解层次</font>是NLP中的一个核心概念。</p>
<p>​    在这个世界上，每一件与我们有关系的事，我们都会赋予其一些意义。比如前面的例子，有些人可能会觉得造成这一切“都是马云的错”这就是他赋予的意义。</p>
<p>​    但是，每个人对同一件事情所赋予的意义是不一样的，因此，我们的理解就会不同，而理解不同，各自给出的解决方案当然就会不同。</p>
<p>​    “NLP理解层次”把对一件事情的理解分为了六个不同的层次，而这些层次是有高低之分的。如果你用低维度的视角去看这个问题，可能会感觉它根本无法解决。但当你站在一个更高的维度去看它，它也许就变成了一个很简单的问题，甚至连问题本身也消失了。就像马车时代，大家都在寻找更快的马，但是当汽车被发明出来之后，这个问题就不存在了，因为马的快慢已经变的无关紧要了。</p>
<p>​    那么接下来，我们就从这个线下门店的案例出发，看看这六类人分别会如何思考，如何解决这个问题。</p>
<h2 id="第五流人才"><a href="#第五流人才" class="headerlink" title="第五流人才"></a>第五流人才</h2><p>别名：怨妇</p>
<p>所处理解层次：环境</p>
<p>典型思考模式：都是你们的错！</p>
<p>​    什么是环境？就是除你自己之外的一切都算是环境：你身边的人，你的领导、同事，你的公司，你的竞争对手，市场环境，天气，大众舆论，诸如此类。</p>
<p>​    处在这个理解层次的人，当问题发生的时候，他首先会把问题归结到“因为环境的不好”而产生的问题。比如：</p>
<ul>
<li>工作不顺利，是因为领导是个蠢蛋</li>
<li>没有晋升机会，是因为公司的办公室政治严重，没有好的晋升机制……</li>
<li>房子太贵买不起，都是因为那些黑心炒房团、政府调控不到位、没有一个富爸爸</li>
</ul>
<p>​    总之，发生了现在这个困局，不是我的问题，都是别人的问题，是公司、市场、政府、运气的问题，都是我命不好，生在了这样的一个时代，遇到了这样的一群人……</p>
<p>​    而他寻找解决办法的路径，也会从改变环境的角度去思考：</p>
<ul>
<li> 这家公司不好，导致我没有晋升机会，那我就换个公司呗</li>
<li>找了一个男朋友，他现在越来越差了，又是一个渣男，在换一个呗</li>
</ul>
<p>​    那就是因为他们所理解的层次处在了最低的“环境层”，他们对世界的理解被死死地困在了这个层次，并不是他们想抱怨，而是在他眼里，出了看到环境之外，再也无法看到其他的了。因此，他们能想到的最好的办法，也就只能换个更好的环境了……</p>
<h2 id="第四流人才"><a href="#第四流人才" class="headerlink" title="第四流人才"></a>第四流人才</h2><p>别名：行动派</p>
<p>所处理解层次：行动</p>
<p>典型思考模式：我还不够努力</p>
<p>​    想要解决问题，那你就得开始行动啊！你不改变环境，你能改变的只有你自己！你为什么还没成功？就是因为你还不够努力！你不改变，环境如何改变？你不行动，环境如何改善？</p>
<p>​    处在这个理解层次的人，当问题发生时，他首先会把问题归结到“因为我的努力还不够”而产生的问题。比如：</p>
<ul>
<li>收入太低？因为我还不够努力</li>
<li>买不起房子？因为我还不够努力</li>
</ul>
<p>​    总之，发生了问题，先从自身找原因，看看是不是因为自己偷懒了，是不是自己努力程度还不够，是不是要加大工作量。</p>
<p>​    如果你处在“行动”这个层次上，“环境”的问题就变得不是那么重要了，因为一切都是自己的原因，因为自己还不够努力！而要解决问题也会从“行为”这个层面去寻找解决办法，比如：</p>
<ul>
<li>都一年没涨工资了，今晚开始多加1个小时的班</li>
<li>公司业绩变差了？那一定是我睡觉睡的太多了，明天开始不睡觉了</li>
</ul>
<p>​    但是，我们不禁要问了，是不是努力了，所有的问题就都能解决了呢？</p>
<p>​    越努力的人，获得的成就也就会越大？</p>
<p>​    努力，的确是成功的一个必要条件，但远远不是充分条件。</p>
<p>​    问题的解决，时代的进步，并不只靠“努力”就能完成的，一定有更重要的因素在背后推动，我们需要进入下一个理解层次……</p>
<h2 id="第三流人才"><a href="#第三流人才" class="headerlink" title="第三流人才"></a>第三流人才</h2><p>别名：战术家</p>
<p>所处理解层次：能力</p>
<p>典型思考模式：方法总比问题多！</p>
<p>​    农业时代的人可能比我们更加忙碌，但生产力却不足现代人的万分之一，这是为什么？    </p>
<p>​    因为现在的人更勤奋么？当然不是，是因为他们没有经历过工业革命、信息革命，他们不会使用机器，也不会使用互联网来提高工作效率、协作效率。5000年前，你想要告诉一个人一件事情，你的策马奔腾三天三夜，而现在通过互联网不需要1秒钟—-互联网扩展了你的沟通能力。</p>
<p>​    所以什么是能力？</p>
<p>​    <font color=red>能力就是你能用更简单、更高效的方式解决同样的问题，有选择便是能力</font></p>
<p>​    理解层次处在“能力层”的人，会在“能力”层寻找更好的“方法”来解决问题。比如：</p>
<ul>
<li>线下门店生意不好，是因为我的经营模式太陈旧，我需要学习新的方法……比如：可以通过社群经济方式来降低我的获客成本，提高客户复购率……</li>
<li>以前我是做业务的，现在刚成为部门经理，团队业绩下滑，一定是我的管理能力有问题，我以前根本没有系统学习过管理的方法，我得去报MBA，从“古狄逊定理”开始学起……</li>
</ul>
<p>​    这类人有非常强大的学习能力和应用能力，能把学到的知识，转化为可操作的方法，进而改善效率，解决问题。他们明白，任何问题都不是孤立存在的，一定有人曾经遇到过，并且已经有更好的解决办法了，只是我还不知道。</p>
<p>​    如果你能走到底这个层次，既有“行为层”的勤奋努力，又有“能力层”的方法套路，一般就能成为公司里的中高层了。普通的问题已经难不倒你了，你总能找到办法来解决它们。</p>
<h2 id="第二流人才"><a href="#第二流人才" class="headerlink" title="第二流人才"></a>第二流人才</h2><p>别名：战略家</p>
<p>所处理解层次：BVR（信念/价值观/规条）</p>
<p>典型思考模式：什么才是更重要的？</p>
<p>”能力“层是做解答题的能力，“BVR”层就是做选择题的能力，什么可以做，什么不可以做，什么更重要，什么可以忽略不管。</p>
<h2 id="第一流人才"><a href="#第一流人才" class="headerlink" title="第一流人才"></a>第一流人才</h2><p>别名：觉醒者</p>
<p>所处理解层次：身份</p>
<p>典型思考模式：因为我是XXX，所以我会XXX</p>
<h2 id="顶级人才"><a href="#顶级人才" class="headerlink" title="顶级人才"></a>顶级人才</h2><p>别名：领袖/伟人</p>
<p>所处理解层次：精神/使命</p>
<p>典型思考模式：人活着就是为了改变世界</p>
<p>备注：摘抄自谢春霖《认知红利》</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-09-03T14:56:56.000Z" title="2022/9/3 下午10:56:56">2022-09-03</time>发表</span><span class="level-item"><time dateTime="2022-10-25T13:52:11.430Z" title="2022/10/25 下午9:52:11">2022-10-25</time>更新</span><span class="level-item">6 分钟读完 (大约926个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/09/03/Flink-DataStream-API%E5%AD%A6%E4%B9%A0/">Flink DataStream API学习</a></h1><div class="content"><h1 id="1-source"><a href="#1-source" class="headerlink" title="1.source"></a>1.source</h1><ul>
<li>文件</li>
<li>消息流（kafka、socket）</li>
<li>数组</li>
</ul>
<p>自定义source，实现SourceFunction接口重写方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Event</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String user;</span><br><span class="line">    <span class="keyword">public</span> String url;</span><br><span class="line">    <span class="keyword">public</span> Long timestamp;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Event</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Event</span><span class="params">(String user, String url, Long timestamp)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.user = user;</span><br><span class="line">        <span class="keyword">this</span>.url = url;</span><br><span class="line">        <span class="keyword">this</span>.timestamp = timestamp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Event&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;user=&#x27;&quot;</span> + user + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, url=&#x27;&quot;</span> + url + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, timestamp=&quot;</span> + <span class="keyword">new</span> Timestamp(timestamp) +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClickSource</span> <span class="keyword">implements</span> <span class="title">SourceFunction</span>&lt;<span class="title">Event</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// 声明一个标志位</span></span><br><span class="line">    <span class="keyword">private</span> Boolean running = <span class="keyword">true</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(SourceContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 随机生成数据</span></span><br><span class="line">        Random random = <span class="keyword">new</span> Random();</span><br><span class="line">        String[] users = &#123;<span class="string">&quot;mary&quot;</span>,<span class="string">&quot;alice&quot;</span>,<span class="string">&quot;bob&quot;</span>,<span class="string">&quot;cary&quot;</span>&#125;;</span><br><span class="line">        String[] urls = &#123;<span class="string">&quot;./home&quot;</span>,<span class="string">&quot;./cart&quot;</span>,<span class="string">&quot;./fav&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(running)&#123;</span><br><span class="line">            String user=users[random.nextInt(users.length)];</span><br><span class="line">            String url=urls[random.nextInt(urls.length)];</span><br><span class="line">            Long timestamp = Calendar.getInstance().getTimeInMillis();</span><br><span class="line">            ctx.collect(<span class="keyword">new</span> Event(user,url,timestamp));</span><br><span class="line">            Thread.sleep(<span class="number">1000L</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        running=<span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SourceCustomTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        DataStreamSource&lt;Event&gt; customSource = env.addSource(<span class="keyword">new</span> ClickSource());</span><br><span class="line"></span><br><span class="line">        customSource.print();</span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="2-基本转换算子"><a href="#2-基本转换算子" class="headerlink" title="2.基本转换算子"></a>2.基本转换算子</h1><p>map、filter、flatMap</p>
<ul>
<li>自定义实现接口</li>
<li>使用匿名类</li>
<li>lambda表达式</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransformMap</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 从元素中读取数据</span></span><br><span class="line">        DataStreamSource&lt;Event&gt; eleStream = env.fromElements(<span class="keyword">new</span> Event(<span class="string">&quot;mary&quot;</span>, <span class="string">&quot;./home&quot;</span>, <span class="number">10000L</span>),</span><br><span class="line">                <span class="keyword">new</span> Event(<span class="string">&quot;bob&quot;</span>, <span class="string">&quot;./product&quot;</span>, <span class="number">20000L</span>),</span><br><span class="line">                <span class="keyword">new</span> Event(<span class="string">&quot;alice&quot;</span>, <span class="string">&quot;./cart&quot;</span>, <span class="number">30000L</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1.进行转换计算，提取user字段</span></span><br><span class="line">        SingleOutputStreamOperator&lt;String&gt; res = eleStream.map(<span class="keyword">new</span> MyMapper());</span><br><span class="line">        res.print();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.使用匿名类</span></span><br><span class="line">        SingleOutputStreamOperator&lt;String&gt; res1 = eleStream.map(<span class="keyword">new</span> MapFunction&lt;Event, String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">map</span><span class="params">(Event event)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> event.user;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        res1.print();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.lambda表达式</span></span><br><span class="line">        SingleOutputStreamOperator&lt;String&gt; res2 = eleStream.map(data -&gt; data.user);</span><br><span class="line">       <span class="comment">// SingleOutputStreamOperator&lt;Event&gt; filter2 = eleStream.filter(data-&gt;data.user.equals(&quot;mary&quot;));</span></span><br><span class="line"> <span class="comment">//      eleStream.flatMap((Event event,Collector&lt;String&gt; out)-&gt;&#123;</span></span><br><span class="line"><span class="comment">//            if(event.user.equals(&quot;bob&quot;))&#123;</span></span><br><span class="line"><span class="comment">//                out.collect(event.user);</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//        &#125;).returns(new TypeHint&lt;String&gt;() &#123;&#125;)   // collecter会泛型擦除,所以得使用returns指定返回类型</span></span><br><span class="line"><span class="comment">//                .print(&quot;1&quot;);</span></span><br><span class="line">        res2.print();</span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 自定义mapfunction</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMapper</span> <span class="keyword">implements</span> <span class="title">MapFunction</span>&lt;<span class="title">Event</span>,<span class="title">String</span>&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">map</span><span class="params">(Event event)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> event.user;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="3-聚合算子"><a href="#3-聚合算子" class="headerlink" title="3.聚合算子"></a>3.聚合算子</h1><p>KeyBy</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">        <span class="comment">// 按键分组之后进行聚合,提取最近一次访问数据</span></span><br><span class="line"><span class="comment">//        eleStream.keyBy(new KeySelector&lt;Event, String&gt;() &#123;</span></span><br><span class="line"><span class="comment">//            @Override</span></span><br><span class="line"><span class="comment">//            public String getKey(Event event) throws Exception &#123;</span></span><br><span class="line"><span class="comment">//                return event.user;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//        &#125;).max(&quot;timestamp&quot;).print();</span></span><br><span class="line">        <span class="comment">// 该值最近</span></span><br><span class="line">        eleStream.keyBy(data-&gt;data.user).max(<span class="string">&quot;timestamp&quot;</span>).print(<span class="string">&quot;max &quot;</span>);</span><br><span class="line">        <span class="comment">// 整条数据最近</span></span><br><span class="line">        eleStream.keyBy(data-&gt;data.user).maxBy(<span class="string">&quot;timestamp&quot;</span>).print(<span class="string">&quot;maxBy &quot;</span>);</span><br><span class="line">        env.execute();</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2022/09/14/mYrVo8GWiw1MELX.png" alt="max_vs_maxby.png"></p>
<h1 id="4-Sink"><a href="#4-Sink" class="headerlink" title="4.Sink"></a>4.Sink</h1><p>1.sink to file</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从元素中读取数据</span></span><br><span class="line">DataStreamSource&lt;Event&gt; eleStream = env.fromElements(<span class="keyword">new</span> Event(<span class="string">&quot;mary&quot;</span>, <span class="string">&quot;./home&quot;</span>, <span class="number">10000L</span>),</span><br><span class="line">        <span class="keyword">new</span> Event(<span class="string">&quot;bob&quot;</span>, <span class="string">&quot;./product&quot;</span>, <span class="number">20000L</span>),</span><br><span class="line">        <span class="keyword">new</span> Event(<span class="string">&quot;alice&quot;</span>, <span class="string">&quot;./cart&quot;</span>, <span class="number">30000L</span>),</span><br><span class="line">        <span class="keyword">new</span> Event(<span class="string">&quot;bob&quot;</span>, <span class="string">&quot;./product&quot;</span>, <span class="number">34000L</span>),</span><br><span class="line">        <span class="keyword">new</span> Event(<span class="string">&quot;alice&quot;</span>, <span class="string">&quot;./cart?id=1&quot;</span>, <span class="number">35000L</span>),</span><br><span class="line">        <span class="keyword">new</span> Event(<span class="string">&quot;mary&quot;</span>, <span class="string">&quot;./home&quot;</span>, <span class="number">110000L</span>),</span><br><span class="line">        <span class="keyword">new</span> Event(<span class="string">&quot;bob&quot;</span>, <span class="string">&quot;./product&quot;</span>, <span class="number">210000L</span>),</span><br><span class="line">        <span class="keyword">new</span> Event(<span class="string">&quot;alice&quot;</span>, <span class="string">&quot;./cart&quot;</span>, <span class="number">310000L</span>),</span><br><span class="line">        <span class="keyword">new</span> Event(<span class="string">&quot;bob&quot;</span>, <span class="string">&quot;./product&quot;</span>, <span class="number">341000L</span>),</span><br><span class="line">        <span class="keyword">new</span> Event(<span class="string">&quot;alice&quot;</span>, <span class="string">&quot;./cart?id=1&quot;</span>, <span class="number">351000L</span>)</span><br><span class="line">);</span><br><span class="line">StreamingFileSink&lt;String&gt; build = StreamingFileSink.&lt;String&gt;forRowFormat(<span class="keyword">new</span> Path(<span class="string">&quot;./output&quot;</span>),</span><br><span class="line">                <span class="keyword">new</span> SimpleStringEncoder&lt;&gt;(<span class="string">&quot;UTF-8&quot;</span>))</span><br><span class="line">        .withRollingPolicy(</span><br><span class="line">                DefaultRollingPolicy.builder()</span><br><span class="line">                        .withMaxPartSize(<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">1024</span>)</span><br><span class="line">                        .withInactivityInterval(TimeUnit.MINUTES.toMillis(<span class="number">15</span>))</span><br><span class="line">                        .build()</span><br><span class="line">        )</span><br><span class="line">        .build()</span><br><span class="line">        ;</span><br><span class="line"></span><br><span class="line">eleStream.map(data-&gt;data.toString())</span><br><span class="line">        .addSink(build);</span><br><span class="line">env.execute();</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>sink to kafka</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">env.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.从kafka读取数据</span></span><br><span class="line">Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">properties.setProperty(<span class="string">&quot;bootstrap.servers&quot;</span>,<span class="string">&quot;localhost:9092&quot;</span>);</span><br><span class="line"></span><br><span class="line">DataStreamSource&lt;String&gt; kafkaStream = env.addSource(<span class="keyword">new</span> FlinkKafkaConsumer&lt;String&gt;(<span class="string">&quot;clicks&quot;</span>,<span class="keyword">new</span> SimpleStringSchema(),properties));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 用flink进行转换处理</span></span><br><span class="line">SingleOutputStreamOperator&lt;String&gt; result = kafkaStream.map(<span class="keyword">new</span> MapFunction&lt;String, String&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">map</span><span class="params">(String value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String[] fields = value.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Event(fields[<span class="number">0</span>].trim(), fields[<span class="number">1</span>].trim(), Long.valueOf(fields[<span class="number">2</span>].trim())).toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 结果数据写入kafka</span></span><br><span class="line">result.addSink(<span class="keyword">new</span> FlinkKafkaProducer&lt;String&gt;(<span class="string">&quot;localhost:9092&quot;</span>,<span class="string">&quot;event&quot;</span>,<span class="keyword">new</span> SimpleStringSchema()));</span><br><span class="line"></span><br><span class="line">env.execute();</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>Sink to redis</li>
</ol>
<p>flink没有提供官方的redis连接器，所以使用bahir提供的连接器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;org.apache.bahir&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;flink-connector-redis_2<span class="number">.11</span>&lt;/artifactId&gt;</span><br><span class="line">	&lt;version&gt;<span class="number">1.0</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建一个jedis配置</span></span><br><span class="line">FlinkJedisPoolConfig config = <span class="keyword">new</span> FlinkJedisPoolConfig.Builder().setHost(<span class="string">&quot;xxx&quot;</span>).build;</span><br><span class="line"><span class="comment">// 写入redis</span></span><br><span class="line">stream.addSink(<span class="keyword">new</span> RedisSink&lt;&gt;(config,<span class="keyword">new</span> MyredisMapper()))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义实现redisMapper接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyredisMapper</span> <span class="keyword">implements</span> <span class="title">RedisMapper</span>&lt;<span class="title">Event</span>&gt;</span>&#123;</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> RedisCommandDescription <span class="title">getCommandDescription</span><span class="params">()</span></span>&#123;</span><br><span class="line">      <span class="comment">// 第一个参数:命令 第二个参数:命令对应的参数</span></span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> RedisCommandDescription(RedisCommand.HSET,<span class="string">&quot;clicks&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> String <span class="title">getKeyFromData</span><span class="params">(Event data)</span></span>&#123;</span><br><span class="line">			<span class="keyword">return</span> data.user;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> String <span class="title">getValueFromData</span><span class="params">(Event data)</span></span>&#123;</span><br><span class="line">			<span class="keyword">return</span> data.url;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>sink to es</li>
</ol>
<p>官方提供es连接器 <code>flink-connector-elasticsearch7</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义elasticsearchSinkFunction</span></span><br><span class="line">ElasticserachSinkFunction&lt;Event&gt; esSinkFunction = <span class="keyword">new</span> ElasticsearchSinFunction&lt;Event&gt;()&#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(Event element,RuntimeContext ctx, RequestIndexer indexer)</span></span>&#123;</span><br><span class="line">		<span class="keyword">new</span> HashMap&lt;String,String&gt; map = <span class="keyword">new</span> HashMap();</span><br><span class="line">		map.put(element.user,element.url);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 构建一个IndexRequest</span></span><br><span class="line">		IndexRequest request = Requests.indexRequest().index(<span class="string">&quot;clicks&quot;</span>).type(<span class="string">&quot;type&quot;</span>).source(map);</span><br><span class="line">		</span><br><span class="line">		indexer.add(request);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">stream.addSink(<span class="keyword">new</span> ElasticserachSink.Builder&lt;&gt;(httpHost,esSinkFunction).build());</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>sink to mysql</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;org.apache.flink&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;flink-connector-jdbc_$&#123;scala.binary.version&#125;&lt;/artifactId&gt;</span><br><span class="line">&lt;version&gt;$&#123;flink.version&#125;&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class="line">&lt;version&gt;<span class="number">5.1</span><span class="number">.47</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="comment">// 1.insert 2.用户名密码</span></span><br><span class="line"> stream.addSink(</span><br><span class="line">JdbcSink.sink(</span><br><span class="line"><span class="string">&quot;INSERT INTO clicks (user, url) VALUES (?, ?)&quot;</span>,</span><br><span class="line">(statement, r) -&gt; &#123;</span><br><span class="line">statement.setString(<span class="number">1</span>, r.user);</span><br><span class="line">statement.setString(<span class="number">2</span>, r.url);</span><br><span class="line">&#125;,</span><br><span class="line"><span class="keyword">new</span> </span><br><span class="line">JdbcConnectionOptions.JdbcConnectionOptionsBuilder()</span><br><span class="line">.withUrl(<span class="string">&quot;jdbc:mysql://localhost:3306/userbe</span></span><br><span class="line"><span class="string">havior&quot;</span>)</span><br><span class="line"><span class="comment">// 对于 MySQL 5.7，用&quot;com.mysql.jdbc.Driver&quot;</span></span><br><span class="line">.withDriverName(<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>)</span><br><span class="line">.withUsername(<span class="string">&quot;username&quot;</span>)</span><br><span class="line">.withPassword(<span class="string">&quot;password&quot;</span>)</span><br><span class="line">.build()</span><br><span class="line">)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-08-30T14:03:15.000Z" title="2022/8/30 下午10:03:15">2022-08-30</time>发表</span><span class="level-item"><time dateTime="2022-09-03T14:51:57.194Z" title="2022/9/3 下午10:51:57">2022-09-03</time>更新</span><span class="level-item">7 分钟读完 (大约1041个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/08/30/flink%E9%87%8D%E8%A6%81%E6%A6%82%E5%BF%B5/">flink重要概念</a></h1><div class="content"><h1 id="一、Flink组件"><a href="#一、Flink组件" class="headerlink" title="一、Flink组件"></a>一、Flink组件</h1><h2 id="1-JobManager"><a href="#1-JobManager" class="headerlink" title="1.JobManager"></a>1.JobManager</h2><p>作为主进程，JobManager控制着单个应用程序的执行。JobManager可以接收所需要执行的应用，该应用会包含一个JobGraph，即逻辑DataFlow图，以及一个打包的Jar文件。JobManager将JobGraph转换为ExecutionGraph的物理DataFlow图，该图包含了哪些可以并行执行的任务。JobManager从ResourceManager申请必要的执行资源（槽-TaskManager的slot），然后将ExecutionGraph中的任务分发给TaskManger来执行。在此过程中，JobManager还负责所有需要集中协调的操作，如创建checkpoint。</p>
<p>总的来说有两点：</p>
<ul>
<li>提交程序</li>
<li>创建checkpoint</li>
</ul>
<h2 id="2-ResourceManager"><a href="#2-ResourceManager" class="headerlink" title="2.ResourceManager"></a>2.ResourceManager</h2><p>ResourceManger负责管理flink的处理资源单元—-槽。</p>
<p>总的来说两点：</p>
<ul>
<li>分配资源</li>
<li>释放计算资源</li>
</ul>
<h2 id="3-TaskManager"><a href="#3-TaskManager" class="headerlink" title="3.TaskManager"></a>3.TaskManager</h2><p>TaskManager是flink的工作进程。通过会启动多个TaskManager，每个TaskManger有多个槽。槽的个数限制了TaskManager可并行执行的任务数。TaskManager在启动后，会向ResourceManger注册它的槽，当接收到ResourceManger的指示时，TaskManager会向JobManager提供一个或多个槽。在执行期间，运行同一应用不同任务的TaskManager之间会产生数据交换。</p>
<p>总的来说三点：</p>
<ul>
<li><p>提供槽</p>
</li>
<li><p>执行任务</p>
</li>
<li><p>同应用交换数据</p>
</li>
</ul>
<h2 id="4-Dispatcher"><a href="#4-Dispatcher" class="headerlink" title="4.Dispatcher"></a>4.Dispatcher</h2><p>提供rest接口让我们提交应用程序。一旦提交执行，dispatcher会启动一个JobManager并转交给它。</p>
<h2 id="5-图示组件关系"><a href="#5-图示组件关系" class="headerlink" title="5.图示组件关系"></a>5.图示组件关系</h2><p><img src="https://s2.loli.net/2022/08/31/KVvXUPw97br3RZY.png" alt="flink组件交互.png"></p>
<h1 id="二、任务执行"><a href="#二、任务执行" class="headerlink" title="二、任务执行"></a>二、任务执行</h1><p>下图展示TaskManager、处理槽（slot）、任务以及算子之间的关系</p>
<p><img src="https://s2.loli.net/2022/09/03/n9y5PCqtrMf1l2p.png" alt="flink任务执行.png"></p>
<p>左侧的JobGraph包含了5个算子（右下角标为并行度），其中算子A和C是数据源。由于算子最大并行度为4，因此至少需要4个槽（slot）来处理。若每个TaskManager内有两个槽（slot），则需要运行两个TaskManager可满足该任务需求。JobManager将JobGraph【展开成】ExecutionGraph并把任务分配到4个空闲的处理槽。将任务以切片的形式调度至处理槽中的好处是TaskManager中的多个任务可以在同一个进程内高效地执行数据交换而无须访问网络。</p>
<h1 id="三、Flink降低任务通信开销技术"><a href="#三、Flink降低任务通信开销技术" class="headerlink" title="三、Flink降低任务通信开销技术"></a>三、Flink降低任务通信开销技术</h1><p>通过网络连接逐条发送记录低效且会导致很多额外的开销，若想充分利用网络带宽，就需要进行数据缓冲。如何缓冲flink通过如下两种方式实现。</p>
<h2 id="1-基于信用值（credit）的流量控制"><a href="#1-基于信用值（credit）的流量控制" class="headerlink" title="1.基于信用值（credit）的流量控制"></a>1.基于信用值（credit）的流量控制</h2><ul>
<li><p>发送任务：Sender</p>
</li>
<li><p>接收任务：Receiver</br></p>
<p>当Receiver压力过大时，Receiver会给Sender发送授予一定的信用值，告诉Sender保留一些将要发给它的数据（发送到缓冲区）。等到Receiver有能力处理消息之后在将积压的数据发送给Receiver。</p>
</li>
</ul>
<p>总结：Sender和Receiver通过互相告知对方自己的处理能力的方式来精准地进行流控（批量发可节省资源）</p>
<h2 id="2-任务链接"><a href="#2-任务链接" class="headerlink" title="2.任务链接"></a>2.任务链接</h2><p>前提：</p>
<ul>
<li><p>多个算子必须有相同的并行度</p>
</li>
<li><p>通过本地转发通道</p>
</li>
</ul>
<p>多个算子的函数被“融合”到同一个任务中，在同一个线程内执行。函数生成的记录只需要简单的方法调用就可以分别发往各自的下游函数，从而减少通信开销</p>
<p><img src="https://s2.loli.net/2022/09/03/zU74sPwhGNp9CEY.png" alt="flink通信-任务链接.png"></p>
<p>但是有时候我们需要对长任务链接进行切分或将两个计算量大的函数分配到不同的槽中，就需要特定的处理了</p>
<h1 id="四、时间处理"><a href="#四、时间处理" class="headerlink" title="四、时间处理"></a>四、时间处理</h1><h2 id="1-水位线（watermark）"><a href="#1-水位线（watermark）" class="headerlink" title="1.水位线（watermark）"></a>1.水位线（watermark）</h2><p>watermark是用来解决数据延迟、乱序等问题</p>
<p>参考：</p>
<ol>
<li>概念讲解：<a target="_blank" rel="noopener" href="https://www.modb.pro/db/128738">https://www.modb.pro/db/128738</a></li>
<li>代码示例：<a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1539213">https://cloud.tencent.com/developer/article/1539213</a></li>
</ol>
<h1 id="五、状态管理"><a href="#五、状态管理" class="headerlink" title="五、状态管理"></a>五、状态管理</h1></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-08-29T14:54:07.000Z" title="2022/8/29 下午10:54:07">2022-08-29</time>发表</span><span class="level-item"><time dateTime="2022-08-29T15:10:40.071Z" title="2022/8/29 下午11:10:40">2022-08-29</time>更新</span><span class="level-item">3 分钟读完 (大约513个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/08/29/%E5%8D%95%E6%9C%BA%E7%89%88flink%E6%8E%A5%E6%94%B6kafka%E6%B6%88%E6%81%AF/">单机版flink接收kafka消息</a></h1><div class="content"><h1 id="1-版本对应"><a href="#1-版本对应" class="headerlink" title="1.版本对应"></a>1.版本对应</h1><p>在调试过程中，因为版本不一致一直报错<code>Could not create actor system</code>，最后版本对应起来就能正常消费了。</p>
<ul>
<li>flink版本：1.13.0</li>
<li>scala版本：2.12</li>
<li>kafka版本：kafka_2.12-3.2.1（2.12是scala版本，3.2.1是kafka版本）</li>
</ul>
<h1 id="2-下载kafka"><a href="#2-下载kafka" class="headerlink" title="2.下载kafka"></a>2.下载kafka</h1><p>下载地址：<a target="_blank" rel="noopener" href="https://downloads.apache.org/kafka/3.2.1/kafka_2.12-3.2.1.tgz">https://downloads.apache.org/kafka/3.2.1/kafka_2.12-3.2.1.tgz</a>  </p>
<p> 其中kafka自带zk不需要单独下载zk</p>
<h1 id="3-发送消息"><a href="#3-发送消息" class="headerlink" title="3.发送消息"></a>3.发送消息</h1><ul>
<li>启动zk：<code>bin/zookeeper-server-start.sh config/zookeeper.properties</code></li>
<li>启动kafka：<code>bin/kafka-server-start.sh config/server.properties</code></li>
<li>创建topic：<code>bin/kafka-topics.sh --create --topic test_flink_topic1059 --bootstrap-server localhost:9092</code></li>
<li>生产数据：<code>bin/kafka-console-producer.sh --topic test_flink_topic1059 --bootstrap-server localhost:9092</code></li>
</ul>
<h1 id="4-flink接受消息"><a href="#4-flink接受消息" class="headerlink" title="4.flink接受消息"></a>4.flink接受消息</h1><p>Pom.xml文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">flink.version</span>&gt;</span>1.13.0<span class="tag">&lt;/<span class="name">flink.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scala.binary.version</span>&gt;</span>2.12<span class="tag">&lt;/<span class="name">scala.binary.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">slf4j.version</span>&gt;</span>1.7.30<span class="tag">&lt;/<span class="name">slf4j.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-streaming-java_$&#123;scala.binary.version&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--流处理--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-streaming-scala_$&#123;scala.binary.version&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-clients_$&#123;scala.binary.version&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 引入日志管理相关依赖--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;slf4j.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-log4j12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;slf4j.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-to-slf4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.14.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hadoop<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hadoop-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.10.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hive<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hive-exec<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 连接2.12scala版本的kafka:kafka_2.12-3.2.1 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-connector-kafka_$&#123;scala.binary.version&#125;<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>java程序</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.wc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.serialization.SimpleStringSchema;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.DataStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.connectors.kafka.FlinkKafkaConsumer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KafkaToFlink</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建流处理的执行环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 配置KafKa</span></span><br><span class="line">        <span class="comment">//配置KafKa和Zookeeper的ip和端口</span></span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        properties.setProperty(<span class="string">&quot;bootstrap.servers&quot;</span>, <span class="string">&quot;localhost:9092&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;zookeeper.connect&quot;</span>, <span class="string">&quot;localhost:2181&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;group.id&quot;</span>, <span class="string">&quot;consumer-group&quot;</span>);</span><br><span class="line">        <span class="comment">//将kafka和zookeeper配置信息加载到Flink的执行环境当中StreamExecutionEnvironment</span></span><br><span class="line">        FlinkKafkaConsumer myConsumer = <span class="keyword">new</span> FlinkKafkaConsumer(<span class="string">&quot;test_flink_topic1059&quot;</span>, <span class="keyword">new</span> SimpleStringSchema(),</span><br><span class="line">                properties);</span><br><span class="line">        <span class="comment">//添加数据源，此处选用数据流的方式，将KafKa中的数据转换成Flink的DataStream类型</span></span><br><span class="line">        DataStream stream = env.addSource(myConsumer);</span><br><span class="line">        <span class="comment">//打印输出</span></span><br><span class="line">        stream.print();</span><br><span class="line">        <span class="comment">//执行Job，Flink执行环境必须要有job的执行步骤，而以上的整个过程就是一个Job</span></span><br><span class="line">        env.execute(<span class="string">&quot;kafka sink test&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之后在kafka生产数据，就可以看到idea控制台有消息打印</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-08-21T13:47:32.000Z" title="2022/8/21 下午9:47:32">2022-08-21</time>发表</span><span class="level-item"><time dateTime="2022-08-21T14:35:17.229Z" title="2022/8/21 下午10:35:17">2022-08-21</time>更新</span><span class="level-item">3 分钟读完 (大约455个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/08/21/mac%E6%90%AD%E5%BB%BA%E5%8D%95%E6%9C%BAflink%E5%B9%B6%E8%BF%90%E8%A1%8Chelloworld/">mac搭建单机flink并运行helloworld</a></h1><div class="content"><p>准备好好开始学习flink，先从hello world开始吧</p>
<h1 id="1-安装flink"><a href="#1-安装flink" class="headerlink" title="1.安装flink"></a>1.安装flink</h1><p>本文介绍通过brew安装flink</p>
<h2 id="1-1-安装"><a href="#1-1-安装" class="headerlink" title="1.1. 安装"></a>1.1. 安装</h2><p>首先查看是否安装flink使用<code> brew list | grep flink</code>查看，若安装进行启动步骤，若未安装使用<code>brew install openjdk@11; brew install apache-flink</code>指令安装（该过程可能比较漫长，我因为网络不好导致多次下载中断）</p>
<h2 id="1-2启动"><a href="#1-2启动" class="headerlink" title="1.2启动"></a>1.2启动</h2><p>进入<code>/opt/homebrew/Cellar/apache-flink/1.14.0</code>执行<code>./libexec/bin/start-cluster.sh</code>，然后在浏览器访问<code>http://localhost:8081 </code> 会显示如下界面<img src="https://s2.loli.net/2022/08/21/OVhoCeuYdErkxwP.png" alt="flink界面.png"></p>
<h1 id="2-运行helloworld"><a href="#2-运行helloworld" class="headerlink" title="2.运行helloworld"></a>2.运行helloworld</h1><p>在idea中创建maven项目，加入如下代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SocketTextStreamWordCount</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//参数检查</span></span><br><span class="line">        <span class="keyword">if</span> (args.length != <span class="number">2</span>) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;USAGE:\nSocketTextStreamWordCount &lt;hostname&gt; &lt;port&gt;&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String hostName = args[<span class="number">0</span>];</span><br><span class="line">        Integer port = Integer.parseInt(args[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置环境</span></span><br><span class="line">        <span class="keyword">final</span> StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取数据</span></span><br><span class="line">        DataStream&lt;String&gt; text = env.socketTextStream(hostName, port);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//计数</span></span><br><span class="line">        DataStream&lt;Tuple2&lt;String, Integer&gt;&gt; counts = text.flatMap(<span class="keyword">new</span> LineSplitter())</span><br><span class="line">                .keyBy(<span class="number">0</span>)</span><br><span class="line">                .sum(<span class="number">1</span>);</span><br><span class="line">        counts.print();</span><br><span class="line"></span><br><span class="line">        env.execute(<span class="string">&quot;Java WordCount from SocketTextStream Example&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LineSplitter</span> <span class="keyword">implements</span> <span class="title">FlatMapFunction</span>&lt;<span class="title">String</span>, <span class="title">Tuple2</span>&lt;<span class="title">String</span>, <span class="title">Integer</span>&gt;&gt; </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">flatMap</span><span class="params">(String s, Collector&lt;Tuple2&lt;String, Integer&gt;&gt; collector)</span> </span>&#123;</span><br><span class="line">            String[] tokens = s.toLowerCase().split(<span class="string">&quot;\\W+&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (String token: tokens) &#123;</span><br><span class="line">                <span class="keyword">if</span> (token.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    collector.collect(<span class="keyword">new</span> Tuple2&lt;String, Integer&gt;(token, <span class="number">1</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>pom.xml</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;properties&gt;</span><br><span class="line">    &lt;maven.compiler.source&gt;<span class="number">8</span>&lt;/maven.compiler.source&gt;</span><br><span class="line">    &lt;maven.compiler.target&gt;<span class="number">8</span>&lt;/maven.compiler.target&gt;</span><br><span class="line">    &lt;flink.version&gt;<span class="number">1.13</span><span class="number">.0</span>&lt;/flink.version&gt;</span><br><span class="line">    &lt;java.version&gt;<span class="number">1.8</span>&lt;/java.version&gt;</span><br><span class="line">    &lt;scala.binary.version&gt;<span class="number">2.12</span>&lt;/scala.binary.version&gt;</span><br><span class="line">    &lt;slf4j.version&gt;<span class="number">1.7</span><span class="number">.30</span>&lt;/slf4j.version&gt;</span><br><span class="line">&lt;/properties&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.flink&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;flink-java&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;$&#123;flink.version&#125;&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.flink&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;flink-streaming-java_$&#123;scala.binary.version&#125;&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;$&#123;flink.version&#125;&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.flink&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;flink-clients_$&#123;scala.binary.version&#125;&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;$&#123;flink.version&#125;&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>然后打包程序</p>
<p>开启监听端口<code> nc -l 9000</code></p>
<p>最后在后台运行</p>
<p><code>./bin/flink run -c com.atguigu.wc.SocketTextStreamWordCount /Users/guozaizai/IdeaProjects/guigu_flink/target/guigu_flink-1.0-SNAPSHOT.jar 127.0.0.1 9000</code>，此时我们可以在界面看到正在运行的程序（如果报ip解析错误在flink-conf.yaml中配置taskmanager.host: localhost）<img src="https://s2.loli.net/2022/08/21/NupJqvE7RQIAhPF.png" alt="flink正在运行的程序.png"></p>
<p>之后我们可以在nc中输入text，然后可以通过<code>tail -f ./libexec/log/flink-xxx-taskexecutor-1-xxx-Pro.local.out</code>看到统计结果<img src="https://s2.loli.net/2022/08/21/vMPH2aK5utXiCxS.png" alt="flink观测结果.png"></p>
<p>参考：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/17676d34dd35">https://www.jianshu.com/p/17676d34dd35</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-07-30T07:35:43.000Z" title="2022/7/30 下午3:35:43">2022-07-30</time>发表</span><span class="level-item"><time dateTime="2022-07-30T09:12:43.480Z" title="2022/7/30 下午5:12:43">2022-07-30</time>更新</span><span class="level-item">7 分钟读完 (大约1109个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/07/30/Spark%E7%9A%84JOIN%E7%AD%96%E7%95%A5/">Spark的JOIN策略</a></h1><div class="content"><h1 id="一、JOIN背景介绍"><a href="#一、JOIN背景介绍" class="headerlink" title="一、JOIN背景介绍"></a>一、JOIN背景介绍</h1><p>Join是数据库查询永远绕不开的话题，传统查询SQL技术总体可以分为简单操作、聚合操作groupby以及join操作等。其中join操作是最复杂、代价最大的操作类型。也是olap场景中使用相对较多的操作。</p>
<h1 id="二、基本实现机制"><a href="#二、基本实现机制" class="headerlink" title="二、基本实现机制"></a>二、基本实现机制</h1><p>spark中有5中join机制</p>
<ul>
<li><p>Broadcast Hash Join</p>
</li>
<li><p>Shuffle Hash Join</p>
</li>
<li><p>Sort Merge Join</p>
</li>
<li><p>Cartesian Join</p>
</li>
<li><p>Broadcast Nested Loop Join</p>
</li>
</ul>
<p>最常见的是前3个，其中Broadcast Hash Join、Shuffle Hash Join两者归根到底都属于<strong>hash join</strong>，只不过在hash前是做broadcast还是shuffle。其实，hash join算法来自传统数据库，而shuffle和broadcast是大数据的皮，两者结合之后就成了大数据的算法了。所以我们先来了解一下hash join的原理</p>
<h2 id="2-1-hash-join"><a href="#2-1-hash-join" class="headerlink" title="2.1 hash join"></a>2.1 hash join</h2><p>先来看这样一条sql <code>select * from order,item where order.id=iterm.id</code> 假设这个join采用hash join算法，过程图如下：<img src="https://s2.loli.net/2022/07/30/yH1LCnhZrgOdmsx.png" alt="hash-join过程.png"></p>
<p>整个过程会经历三步：</p>
<ol>
<li><strong>确定build table基础表以及probe table探测表：</strong>基础表使用join的key构建一个hash table，探测表使用join的key进行探测，探测成功就join在了一起。通常情况下，小表会做为基础表（<font color="red">因为会放在内存中</font>），大表会做为探测表，该示例中iterm为基础表，order表为探测表</li>
<li><strong>构建Hash Table：</strong>依次读取基础表的数据，对于每一行数据根据join key进行hash，hash到对应的bucket，生成hash table中的一条记录，数据缓存在内存中，如果内存放不下就dump到外存</li>
<li><strong>探测：</strong>扫描探测表的数据，使用相同的hash函数映射Hash Table中的记录，映射成功之后再检查join的条件（order.id=iterm.id），如果匹配成功就可以将两者join在一起</li>
</ol>
<h2 id="2-2-broadcast-hash-join"><a href="#2-2-broadcast-hash-join" class="headerlink" title="2.2 broadcast hash join"></a>2.2 broadcast hash join</h2><p>将其中一张小表广播分发到一张大表所在的节点上，分别并发的与其上的分区记录进行hash join。适合表很小直接可以广播的场景</p>
<p><img src="https://s2.loli.net/2022/07/30/kz9yAtRl8nWP3mh.png" alt="broadcast-hash-join.png"></p>
<ol>
<li><strong>broadcast阶段：</strong>将小表广播到大表所在的节点。最简单的是先发给driver然后driver统一分发给所有的executor</li>
<li><strong>hash join阶段：</strong>在每个executor上执行2.1中的hash join，小表做为基础表，大表做为探测表</li>
</ol>
<p>broadcast hash join执行的基本条件为被广播小表必须小于参数 spark.sql.autoBroadcastJoinThreshold，默认为10M</p>
<h2 id="2-3-shuffle-hash-join"><a href="#2-3-shuffle-hash-join" class="headerlink" title="2.3 shuffle hash join"></a>2.3 shuffle hash join</h2><p>在大数据场景下如果一张表很小那么选择broadcast hash join无疑是效率最高的，但是一旦小表数据量增大，广播所需内存、带宽等资源就会太大，broadcast hash join就不再是最优方案。此时，shuffle hash join就是比较合适的方案，先按照key进行分区（<font color="red">此过程会产生shuffle</font> ），就可以将大表join分而治之，划分为很多小表的join，充分利用分布式的优点。</p>
<p><img src="https://s2.loli.net/2022/07/30/HQAWmt45cnzlUgI.png" alt="shuffle-hash-join.png"></p>
<ol>
<li><strong>shuffle 阶段：</strong>将两个表join的key进行分区，那么相同的key将会分配到同一个节点</li>
<li><strong>hash join阶段：</strong>每个节点上进行hash join算法</li>
</ol>
<p>可以看出该算法也用到了hash join意味着节点上的小表也是放在内存中，若节点上的表都是大表那么该算法就不适用了</p>
<h2 id="2-4-sort-merge-join"><a href="#2-4-sort-merge-join" class="headerlink" title="2.4 sort merge join"></a>2.4 sort merge join</h2><p>如果两个大表进行join，spark采用了sort merge join算法</p>
<p><img src="https://s2.loli.net/2022/07/30/D4VPyTI6NutJSb7.png" alt="sort-merge-join.png"></p>
<ol>
<li><strong>shuffle阶段：</strong>将两张大表根据join的key进行shuffle</li>
<li><strong>sort阶段：</strong>对单个分区节点的两张表数据，分别进行排序</li>
<li><strong>merge阶段：</strong>对排好序的两张表执行join操作。join操作很简单，分别遍历两个有序序列，碰到相同的key就merge输出</li>
</ol>
<h1 id="三、总结"><a href="#三、总结" class="headerlink" title="三、总结"></a>三、总结</h1><p>经过上文的分析，很明显可以看出来几种join的代价：<font color="red">broadcast hash join&lt;shuffle hash join&lt;sort merge join</font>，所以优化sql执行时优先以这个顺序去考虑</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-07-24T11:59:49.000Z" title="2022/7/24 下午7:59:49">2022-07-24</time>发表</span><span class="level-item"><time dateTime="2022-07-30T07:31:57.305Z" title="2022/7/30 下午3:31:57">2022-07-30</time>更新</span><span class="level-item">6 分钟读完 (大约949个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/07/24/hive-udf/">hive udaf</a></h1><div class="content"><h2 id="一、问题点"><a href="#一、问题点" class="headerlink" title="一、问题点"></a>一、问题点</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">class </span><br><span class="line">,collect_set(concat_ws(<span class="string">&#x27;,&#x27;</span>,movie_arr)) <span class="keyword">as</span> movie_arr</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">(</span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">name</span><br><span class="line">,class</span><br><span class="line">,collect_set(concat_ws(<span class="string">&#x27;,&#x27;</span>,movie)) <span class="keyword">as</span> movie_arr</span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">(</span><br><span class="line"><span class="keyword">select</span> <span class="string">&#x27;张三&#x27;</span> <span class="keyword">as</span> name,<span class="string">&#x27;天下无贼&#x27;</span> <span class="keyword">as</span> movie,<span class="number">1</span> <span class="keyword">as</span> class</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span> </span><br><span class="line"><span class="keyword">select</span> <span class="string">&#x27;张三&#x27;</span> <span class="keyword">as</span> name,<span class="string">&#x27;霸王别姬&#x27;</span> <span class="keyword">as</span> movie,<span class="number">1</span> <span class="keyword">as</span> class</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span> </span><br><span class="line"><span class="keyword">select</span> <span class="string">&#x27;李四&#x27;</span> <span class="keyword">as</span> name,<span class="string">&#x27;霸王别姬&#x27;</span> <span class="keyword">as</span> movie,<span class="number">1</span> <span class="keyword">as</span> class</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span> </span><br><span class="line"><span class="keyword">select</span> <span class="string">&#x27;王五&#x27;</span> <span class="keyword">as</span> name,<span class="string">&#x27;放牛班的春天&#x27;</span> <span class="keyword">as</span> movie,<span class="number">2</span> <span class="keyword">as</span> class</span><br><span class="line">)</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">name</span><br><span class="line">,class</span><br><span class="line">)</span><br><span class="line">class</span><br><span class="line">;</span><br></pre></td></tr></table></figure>



<p>若遇到以上问题，需求是必须先聚合到明细name+class，然后再聚合到class，这时候在最外层使用collect_set就会报错。</p>
<p>此时，需要实现一个uadf能在数组间进行元素去重。</p>
<h2 id="二、解决办法"><a href="#二、解决办法" class="headerlink" title="二、解决办法"></a>二、解决办法</h2><p>以下是uadf开发流程</p>
<h3 id="2-1-新建Java项目，配置maven文件"><a href="#2-1-新建Java项目，配置maven文件" class="headerlink" title="2.1 新建Java项目，配置maven文件"></a>2.1 新建Java项目，配置maven文件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.hadoop&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;hadoop-common&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">2.10</span><span class="number">.2</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.hive&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;hive-exec&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">2.3</span><span class="number">.7</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-开发功能"><a href="#2-2-开发功能" class="headerlink" title="2.2 开发功能"></a>2.2 开发功能</h3><p>继承<strong>AbstractGenericUDAFResolver</strong>类</p>
<h4 id="2-2-1-关于UDAF的四个阶段"><a href="#2-2-1-关于UDAF的四个阶段" class="headerlink" title="2.2.1 关于UDAF的四个阶段"></a>2.2.1 关于UDAF的四个阶段</h4><p>在编码前，要先了解UDAF的四个阶段，定义在GenericUDAFEvaluator的Mode枚举中：</p>
<p>1.COMPLETE:如果MapReduce只有map而没有reduce，就会进入这个阶段</p>
<p>2.PARTIAL1:正常MapReduce的map阶段</p>
<p>3.PARTIAL2:正常MapReduce的combiner阶段</p>
<p>4.FINAL:正常MapReduce的reduce阶段</p>
<h4 id="2-2-2-每个阶段被调用的方法"><a href="#2-2-2-每个阶段被调用的方法" class="headerlink" title="2.2.2 每个阶段被调用的方法"></a>2.2.2 每个阶段被调用的方法</h4><ul>
<li><p>开发udaf时，要继承抽象类GenericUDAFEvaluator，里面有多个抽象方法，在不同的阶段，会调用到这些方法中的一个或多个</p>
</li>
<li><p>下图对每个阶段调用了哪些方法说的很清楚：<img src="https://s2.loli.net/2022/07/25/vdm5QstyaW2Jkwn.png" alt="udaf.png"></p>
</li>
<li><p>下图对顺序执行的三个阶段和涉及方法做了详细说明<img src="https://s2.loli.net/2022/07/25/X9AYo8jdWUROVnC.png" alt="udaf1.png"></p>
</li>
</ul>
<p>下面是对应的代码实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.ql.exec.Description;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.ql.exec.UDFArgumentTypeException;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.ql.metadata.HiveException;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.ql.parse.SemanticException;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.ql.udf.generic.AbstractGenericUDAFResolver;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.ql.udf.generic.GenericUDAFEvaluator;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.serde2.objectinspector.ListObjectInspector;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.serde2.objectinspector.ObjectInspector;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.serde2.objectinspector.ObjectInspectorFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.serde2.objectinspector.ObjectInspectorUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.serde2.objectinspector.PrimitiveObjectInspector;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.serde2.objectinspector.StandardListObjectInspector;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hive.serde2.typeinfo.TypeInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Description(name = &quot;collect_split_set&quot;, value = &quot;_FUNC_(x) - Returns a set of objects with duplicate elements eliminated&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CollectSplitSet</span> <span class="keyword">extends</span> <span class="title">AbstractGenericUDAFResolver</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> GenericUDAFEvaluator <span class="title">getEvaluator</span><span class="params">(TypeInfo[] parameters)</span> <span class="keyword">throws</span> SemanticException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (parameters.length != <span class="number">1</span>)</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> UDFArgumentTypeException(parameters.length - <span class="number">1</span>, <span class="string">&quot;Exactly one argument is expected.&quot;</span>); </span><br><span class="line">    <span class="keyword">if</span> (parameters[<span class="number">0</span>].getCategory() != ObjectInspector.Category.PRIMITIVE)</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> UDFArgumentTypeException(<span class="number">0</span>, <span class="string">&quot;Only primitive type arguments are accepted but &quot;</span> + parameters[<span class="number">0</span>]</span><br><span class="line">          </span><br><span class="line">          .getTypeName() + <span class="string">&quot; was passed as parameter 1.&quot;</span>); </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MkCollectionSizeEvaluator();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MkCollectionSizeEvaluator</span> <span class="keyword">extends</span> <span class="title">GenericUDAFEvaluator</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> PrimitiveObjectInspector inputOI;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> StandardListObjectInspector loi;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> ListObjectInspector internalMergeOI;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> ObjectInspector <span class="title">init</span><span class="params">(GenericUDAFEvaluator.Mode m, ObjectInspector[] parameters)</span> <span class="keyword">throws</span> HiveException </span>&#123;</span><br><span class="line">      <span class="keyword">super</span>.init(m, parameters);</span><br><span class="line">      <span class="keyword">if</span> (m == GenericUDAFEvaluator.Mode.PARTIAL1) &#123;</span><br><span class="line">        <span class="keyword">this</span>.inputOI = (PrimitiveObjectInspector)parameters[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">return</span> </span><br><span class="line">          (ObjectInspector)ObjectInspectorFactory.getStandardListObjectInspector(</span><br><span class="line">            ObjectInspectorUtils.getStandardObjectInspector((ObjectInspector)<span class="keyword">this</span>.inputOI));</span><br><span class="line">      &#125; </span><br><span class="line">      <span class="keyword">if</span> (!(parameters[<span class="number">0</span>] <span class="keyword">instanceof</span> ListObjectInspector)) &#123;</span><br><span class="line">        <span class="keyword">this</span></span><br><span class="line">          .inputOI = (PrimitiveObjectInspector)ObjectInspectorUtils.getStandardObjectInspector(parameters[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> </span><br><span class="line">          (ObjectInspector)ObjectInspectorFactory.getStandardListObjectInspector((ObjectInspector)<span class="keyword">this</span>.inputOI);</span><br><span class="line">      &#125; </span><br><span class="line">      <span class="keyword">this</span>.internalMergeOI = (ListObjectInspector)parameters[<span class="number">0</span>];</span><br><span class="line">      <span class="keyword">this</span>.inputOI = (PrimitiveObjectInspector)<span class="keyword">this</span>.internalMergeOI.getListElementObjectInspector();</span><br><span class="line">      <span class="keyword">this</span>.loi = (StandardListObjectInspector)ObjectInspectorUtils.getStandardObjectInspector((ObjectInspector)<span class="keyword">this</span>.internalMergeOI);</span><br><span class="line">      <span class="keyword">return</span> (ObjectInspector)<span class="keyword">this</span>.loi;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">MkSetAggregationBuffer</span> <span class="keyword">extends</span> <span class="title">GenericUDAFEvaluator</span>.<span class="title">AbstractAggregationBuffer</span> </span>&#123;</span><br><span class="line">      <span class="keyword">private</span> Collection&lt;Object&gt; container = <span class="keyword">new</span> LinkedHashSet();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> GenericUDAFEvaluator.<span class="function">AggregationBuffer <span class="title">getNewAggregationBuffer</span><span class="params">()</span> <span class="keyword">throws</span> HiveException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> (GenericUDAFEvaluator.AggregationBuffer)<span class="keyword">new</span> MkSetAggregationBuffer();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reset</span><span class="params">(GenericUDAFEvaluator.AggregationBuffer agg)</span> <span class="keyword">throws</span> HiveException </span>&#123;</span><br><span class="line">      ((MkSetAggregationBuffer)agg).container.clear();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">iterate</span><span class="params">(GenericUDAFEvaluator.AggregationBuffer agg, Object[] parameters)</span> <span class="keyword">throws</span> HiveException </span>&#123;</span><br><span class="line">      <span class="keyword">assert</span> parameters.length == <span class="number">1</span>;</span><br><span class="line">      Object p = parameters[<span class="number">0</span>];</span><br><span class="line">      <span class="keyword">if</span> (p != <span class="keyword">null</span>) &#123;</span><br><span class="line">        MkSetAggregationBuffer myagg = (MkSetAggregationBuffer)agg;</span><br><span class="line">        String[] strings = String.valueOf(p).split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (String str : strings) &#123;</span><br><span class="line">          <span class="keyword">if</span> (!<span class="string">&quot;&quot;</span>.equals(str))</span><br><span class="line">            putIntoCollection(<span class="keyword">new</span> Text(str), myagg); </span><br><span class="line">        &#125; </span><br><span class="line">      &#125; </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">putIntoCollection</span><span class="params">(Object p, MkSetAggregationBuffer myagg)</span> </span>&#123;</span><br><span class="line">      Object pCopy = ObjectInspectorUtils.copyToStandardObject(p, (ObjectInspector)<span class="keyword">this</span>.inputOI);</span><br><span class="line">      myagg.container.add(pCopy);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">terminatePartial</span><span class="params">(GenericUDAFEvaluator.AggregationBuffer agg)</span> <span class="keyword">throws</span> HiveException </span>&#123;</span><br><span class="line">      MkSetAggregationBuffer myagg = (MkSetAggregationBuffer)agg;</span><br><span class="line">      List&lt;Object&gt; ret = <span class="keyword">new</span> ArrayList(myagg.container.size());</span><br><span class="line">      ret.addAll(myagg.container);</span><br><span class="line">      <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">merge</span><span class="params">(GenericUDAFEvaluator.AggregationBuffer agg, Object partial)</span> <span class="keyword">throws</span> HiveException </span>&#123;</span><br><span class="line">      MkSetAggregationBuffer myagg = (MkSetAggregationBuffer)agg;</span><br><span class="line">      List&lt;Object&gt; partialResult = <span class="keyword">this</span>.internalMergeOI.getList(partial);</span><br><span class="line">      <span class="keyword">if</span> (partialResult != <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">for</span> (Object i : partialResult)</span><br><span class="line">          putIntoCollection(i, myagg);  </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">terminate</span><span class="params">(GenericUDAFEvaluator.AggregationBuffer agg)</span> <span class="keyword">throws</span> HiveException </span>&#123;</span><br><span class="line">      MkSetAggregationBuffer myagg = (MkSetAggregationBuffer)agg;</span><br><span class="line">      List&lt;Object&gt; ret = <span class="keyword">new</span> ArrayList(myagg.container.size());</span><br><span class="line">      ret.addAll(myagg.container);</span><br><span class="line">      <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">和collect_set的区别：</span><br><span class="line">String[] strings = String.valueOf(p).split(<span class="string">&quot;,&quot;</span>);   <span class="comment">// 多一步解开元素的操作</span></span><br><span class="line"><span class="keyword">for</span> (String str : strings) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="string">&quot;&quot;</span>.equals(str))</span><br><span class="line">    putIntoCollection(<span class="keyword">new</span> Text(str), myagg); </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h3 id="2-3-上传hdfs"><a href="#2-3-上传hdfs" class="headerlink" title="2.3 上传hdfs"></a>2.3 上传hdfs</h3><h3 id="2-4-添加jar"><a href="#2-4-添加jar" class="headerlink" title="2.4 添加jar"></a>2.4 添加jar</h3><p> add jar hdfs:<em>//xxx/myfun-1.0-SNAPSHOT.jar；</em></p>
<h3 id="2-5-创建函数"><a href="#2-5-创建函数" class="headerlink" title="2.5 创建函数"></a>2.5 创建函数</h3><p>create function func_name as “类路径”;</p>
<h3 id="2-6使用"><a href="#2-6使用" class="headerlink" title="2.6使用"></a>2.6使用</h3><p>select func_name()</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-07-19T23:27:41.000Z" title="2022/7/20 上午7:27:41">2022-07-20</time>发表</span><span class="level-item"><time dateTime="2022-07-23T03:45:44.136Z" title="2022/7/23 上午11:45:44">2022-07-23</time>更新</span><span class="level-item">20 分钟读完 (大约2977个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/07/20/%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%E6%A8%A1%E5%9E%8B-%E6%98%9F%E5%9E%8B-%E9%9B%AA%E8%8A%B1-%E6%98%9F%E5%BA%A7/">数据仓库模型-星型,雪花,星座</a></h1><div class="content"><h1 id="一、什么是数据仓库模型？"><a href="#一、什么是数据仓库模型？" class="headerlink" title="一、什么是数据仓库模型？"></a>一、什么是数据仓库模型？</h1><p>模型是描述整个数据库的<strong>逻辑描述</strong>，包括记录的名称和描述。它具有所有数据项以及数据关联的不同聚合</p>
<h1 id="二、数据仓库模型的类型"><a href="#二、数据仓库模型的类型" class="headerlink" title="二、数据仓库模型的类型"></a>二、数据仓库模型的类型</h1><p>事实表和维度表构成了数据仓库中任何<strong>模型</strong>的基础，这些表和维度表对于理解很重要。</p>
<ul>
<li>事实表，应该具有域任何<strong>业务流程对应的数据</strong>。每行代表可以与任何进程关联的任何事件。它存储用于分析的定量信息。</li>
<li>维度表，存储有关如何分析事实表的数据的数据（实体）。它们有助于事实表收集有关将要采取的措施的不同维度。</li>
</ul>
<h2 id="2-1-星型模型"><a href="#2-1-星型模型" class="headerlink" title="2.1 星型模型"></a>2.1 星型模型</h2><p>所有维表都直接连接到“<strong>事实表</strong>”上时，整个图就像星星一样，故将该模型称为星型模型，如图</p>
<p><img src="https://s2.loli.net/2022/07/20/9DueirLv7tWs8FJ.png" alt="星型模型.png"></p>
<p>星型模型是一种非正规化的结构，多维数据集的每一个维度都直接与事实表相连，不存在渐变维度，所以数据有一定的冗余。</p>
<p>如：在地域表中，存在国家A省B城市C以及国家A省B城市D两条记录，那么国家A和省B的信息分别存储了两次，即存在冗余</p>
<h4 id="2-1-1-星型模型的特点"><a href="#2-1-1-星型模型的特点" class="headerlink" title="2.1.1 星型模型的特点"></a>2.1.1 星型模型的特点</h4><ul>
<li>在星型模式中，一个事实表和若干个维度表连接，这种结构类似于星星，因此被称为星形模式。</li>
<li>这里的事实表由数据仓库中的主要信息组成。它围绕较小的维度查找表，这些表将包含不同事实表的详细信息。<strong>每个维度中存在的主键与事实表中的外键相关</strong></li>
<li>事实表采用3NF形式，维度表采用非规范化形式。星型模式中的每个维度都应该由唯一的维度表表示。维度表应该连接到一个事实表。事实表应该有一个键和属性。</li>
</ul>
<h2 id="2-2-雪花模型"><a href="#2-2-雪花模型" class="headerlink" title="2.2 雪花模型"></a>2.2 雪花模型</h2><p>当有一个或多个维度表没有直接连接到事实表上，而是通过其他维度表连接到事实表上时，其图解就像很多个雪花连接在一起，故称为雪花模型。<strong>雪花模型是对星型模型的扩展</strong>。它对星型模型的维表进一步层次化，原有的各个维表可能被扩展为更小的维度表，形成一些局部的“层次区域”，这些被分解的表都连接到主维度表而不是事实表。如图</p>
<p><img src="https://s2.loli.net/2022/07/20/KrOLV5Zxy6ANDhu.png" alt="雪花模型.png"></p>
<p>将地域表分解为国家，省份，城市等维表。它的优点是：通过最大限度地减少数据存储量以及联合较小的维表来<strong>改善查询性能</strong>。雪花结构去除了数据冗余</p>
<p>星型模型因为数据的冗余所以很多统计查询不需要做外部的连接，因此一般情况下效率要比雪花模型要高。星型结构不用考虑很多正规化的因素，设计与实现比较简单。雪花模型去除了冗余，有些统计通过表关联才能产生，所以效率不一定有雪花模型高。正规化也是一种比较复杂的过程，相应的数据库结构设计、数据的ETL、以及后期的维护都要复杂一些。<strong>因此在冗余可以接受的前提下，实际运用中星型模型使用更多，也更有效率</strong></p>
<h2 id="2-3-星座模型（事实星座模型）"><a href="#2-3-星座模型（事实星座模型）" class="headerlink" title="2.3 星座模型（事实星座模型）"></a>2.3 星座模型（事实星座模型）</h2><p>星座模型是由星型模型延伸而来，星型模型是基于一张事实表而星座模型是<strong>基于多张事实表，并且共享维度表的信息</strong>，这种模型往往应用于数据关系比星型模型和雪花模型更复杂的场合。星座模型需要多个事实表共享维度表，因而可以视为星型模型的集合，因此称为星座（系）模型</p>
<p>从本质上讲，可以讲星座模型拆分为互相关联且完全标准化的<strong>星型模型的集合</strong>，以避免数据的冗余和不准确。也可以是雪花模型与星型模型的关联，两个模型的事实表关联，根据需要连接两种结构的维度表。由此产生的系统在结构中看起来像是一个星座，其中事实表是这里的星星。这解释了名称Galaxy模型。这种类型的模型也称为“事实星座”模型，因为他有多个事实表。</p>
<p><img src="https://s2.loli.net/2022/07/20/cRhoIWUyMbBvJak.png" alt="星座模型.png"></p>
<h4 id="2-3-1如何创建星座模型"><a href="#2-3-1如何创建星座模型" class="headerlink" title="2.3.1如何创建星座模型"></a>2.3.1如何创建星座模型</h4><p>当系统由连接到维度表C、D、E、F、G、H、I的事实表A和B组成时，可以构建Galaxy Schema。根据规则，事实表可以相互连接，维度表可以与系统内部的任何事实表和维度表连接，下面的示例将有助于更好地理解Galaxy Schema的底层概念。</p>
<p><img src="https://s2.loli.net/2022/07/21/pVWwObBgFAL5ENP.png" alt="星座模型1.png"></p>
<p>在这个例子中，学生数据库有两个事实表-学生和教职员工。两个事实表都可以有<strong>共同维度</strong>—专业课程、艺术与科学，基于各自部门。此外，从学生角度来看，标准化适用于获得合作社和校外工作。这可以进一步细分以提及经验类型的实习。</p>
<p>另一方面，教学人员会给学生布置作业。并且，这些分配维度表可以进一步规范化以定义评估细节。所有这些维度表都可以根据项目提供给设计团队的信息的局限性进一步规范化。</p>
<h4 id="2-3-2Galaxy-Schema的优缺点"><a href="#2-3-2Galaxy-Schema的优缺点" class="headerlink" title="2.3.2Galaxy Schema的优缺点"></a>2.3.2Galaxy Schema的优缺点</h4><p>优点：</p>
<ul>
<li>它的多维特性有助于有效地构建复杂的数据库系统</li>
<li>作为标准化的结果，最小或没有冗余</li>
<li>考虑到系统的复杂性，这个一个灵活的模式</li>
<li>数据质量会很好，因为规范化为定义明确的表/数据格式提供了优势</li>
<li>高质量和准确性有助于创建出色的报告和分析结果</li>
</ul>
<p>缺点：</p>
<ul>
<li>Galaxy模型在结构上可能很复杂</li>
<li>处理这个模型是乏味的，因为模型和数据库系统的复杂性使它变得更加复杂</li>
<li>数据检索是通过结合条件表达式的多级连接完成的</li>
<li>预期的标准化级别取决于给定数据库的深度</li>
<li>由于galaxy模型用于具有复杂结构的大型数据库系统，因此维护和支持任务变得困难</li>
<li>其较大的设计布置和详细的查询过程需要较大的存储空间</li>
<li>分析变得困难，因为它对可以拥有的事实表和维度表的数量没有限制</li>
</ul>
<h2 id="2-4-对比"><a href="#2-4-对比" class="headerlink" title="2.4 对比"></a>2.4 对比</h2><h4 id="2-4-1雪花-vs-星型"><a href="#2-4-1雪花-vs-星型" class="headerlink" title="2.4.1雪花 vs 星型"></a>2.4.1雪花 vs 星型</h4><p>维度的层级，标准的星型模型的维度层级只有一层，而雪花星型的维度可能涉及到多层</p>
<h4 id="2-4-2星型-vs-星座、雪花"><a href="#2-4-2星型-vs-星座、雪花" class="headerlink" title="2.4.2星型 vs 星座、雪花"></a>2.4.2星型 vs 星座、雪花</h4><p>星座模型基本上是很多数据仓库的常态，因为很多数据仓库都是多个事实表的。所以星座不是星座只反映是否多事实表，他们之间是否共享一些维度表。</p>
<h4 id="2-4-3星型-vs-雪花-vs-星座"><a href="#2-4-3星型-vs-雪花-vs-星座" class="headerlink" title="2.4.3星型 vs 雪花 vs 星座"></a>2.4.3星型 vs 雪花 vs 星座</h4><p><img src="https://s2.loli.net/2022/07/23/hIbCauAgMpjzqvY.png" alt="星型vs雪花vs星座.png"></p>
<table>
<thead>
<tr>
<th>特征</th>
<th>星型架构</th>
<th>雪花架构</th>
<th>星座模型</th>
</tr>
</thead>
<tbody><tr>
<td>维护/更改</td>
<td>它有更多的冗余数据，因此更难更改或维护</td>
<td>由于冗余较少，此模式更易于更改和维护</td>
<td>冗余少，但是结构复杂，难以实现</td>
</tr>
<tr>
<td>易懂</td>
<td>查询的复杂度较低，因此很容易理解</td>
<td>应用的查询更复杂，因此难以理解</td>
<td>复杂</td>
</tr>
<tr>
<td>查询执行 时间</td>
<td>它有更少外键，因此查询执行速度更快，花费时间更少</td>
<td>由于外键较多，查询执行时间较多，或者查询执行速度较慢</td>
<td></td>
</tr>
<tr>
<td>数据仓库类型</td>
<td>更适合具有单一关系的数据集市，即一对一或一对多</td>
<td>更适合复杂的关系，即多对多</td>
<td>复杂的应用程序</td>
</tr>
<tr>
<td>连接数</td>
<td>它有更多的连接数</td>
<td>它有更少的连接数</td>
<td>多</td>
</tr>
<tr>
<td>维度表</td>
<td>每个维度表只有一个维度表</td>
<td>有一个或多个维度表</td>
<td></td>
</tr>
<tr>
<td>可用性</td>
<td>如果维度表的大小较小，即行数较少，则首选星型模式</td>
<td>当维度表较大时很好用</td>
<td></td>
</tr>
<tr>
<td>规范化和非规范化</td>
<td>事实表和维度表都是非规范化的</td>
<td>事实表规范，而维度表都是非规范化的</td>
<td>复杂</td>
</tr>
<tr>
<td>数据模型</td>
<td>它遵循自上而下的方法</td>
<td>自上而下</td>
<td></td>
</tr>
</tbody></table>
<h1 id="三、模型的选择"><a href="#三、模型的选择" class="headerlink" title="三、模型的选择"></a>三、模型的选择</h1><p>首先就是星座不是星座这个只跟数据和需求有关系，跟设计没关系，不用选择</p>
<p>星型还是雪花，取决于性能优先还是避免冗余、灵活度优先</p>
<p>目前实际企业开发中，不会绝对选择一种，根据情况灵活组合，甚至并存。但整体来看，更倾向于维度更少的星型模型。尤其是hadoop体系，减少join就是减少shuffle，性能差距很大</p>
<h2 id="3-1-数据优化"><a href="#3-1-数据优化" class="headerlink" title="3.1 数据优化"></a>3.1 数据优化</h2><p>雪花模型能消除冗余，有效地减少数据量</p>
<h2 id="3-2-业务模型"><a href="#3-2-业务模型" class="headerlink" title="3.2 业务模型"></a>3.2 业务模型</h2><p>主键是一个单独的唯一键(数据属性)，为特殊数据所选择。在上面的例子中，Advertiser_ID 就将是一个主键。外键(参考属性)仅仅是一个表中的字段，用来匹配其他维度表中的主键。在我们所引用的例子中，Advertiser_ID 将是 Account_dimension 的一个外键。</p>
<p>  在雪花模型中，数据模型的业务层级是由一个不同维度表主键-外键的关系来代表的。而在星形模型中，所有必要的维度表在事实表中都只拥有外键。</p>
<h2 id="3-3-性能"><a href="#3-3-性能" class="headerlink" title="3.3 性能"></a>3.3 性能</h2><p>雪花模型join多性能低。</p>
<p>星型模型join少性能高。</p>
<h2 id="3-4-ETL"><a href="#3-4-ETL" class="headerlink" title="3.4 ETL"></a>3.4 ETL</h2><h1 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h1><p>雪花模型使得<strong>维度分析更加容易</strong>，比如”针对特定的广告主，有哪些客户或者公司是在线的“</p>
<p>星型模型用来做指标分析更合适，比如”一个客户他们的收入是多少“</p>
<p><strong>事实星座模式是数据仓库最长使用的数据模式，尤其是企业级数据仓库（EDW）。这也是数据仓库区别于数据集市的一个典型的特征，从根本上而言，数据仓库数据模型的模式更多是为了避免冗余和数据复用，套用现成的模式，是设计数据仓库最合理的选择。当然大数据技术体系下，数据仓库数据模型的设计，还是一个盲点，探索中</strong></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-03-19T15:43:22.000Z" title="2022/3/19 下午11:43:22">2022-03-19</time>发表</span><span class="level-item"><time dateTime="2022-03-19T16:05:11.700Z" title="2022/3/20 上午12:05:11">2022-03-20</time>更新</span><span class="level-item">2 分钟读完 (大约334个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2022/03/19/Driver%E5%92%8CExecutor%E9%80%9A%E4%BF%A1%E6%A8%A1%E6%8B%9F/">Driver和Executor通信模拟</a></h1><div class="content"><h4 id="Driver和Executor通信模拟，体会移动计算理念"><a href="#Driver和Executor通信模拟，体会移动计算理念" class="headerlink" title="Driver和Executor通信模拟，体会移动计算理念"></a><font color='red'>Driver和Executor通信模拟，体会移动计算理念</font></h4><p>1.Driver端代码，driver类似客户端</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.study.bigdata.spark.core.commu</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.&#123;ObjectOutputStream, OutputStream&#125;</span><br><span class="line"><span class="keyword">import</span> java.net.&#123;ServerSocket, Socket&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示driver提交任务到Executor</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">object Driver &#123;</span><br><span class="line">    <span class="function">def <span class="title">main</span><span class="params">(args: Array[String])</span>: Unit </span>= &#123;</span><br><span class="line">        <span class="comment">// 建立连接</span></span><br><span class="line">        val client = <span class="keyword">new</span> Socket(<span class="string">&quot;localhost&quot;</span>, <span class="number">9999</span>)</span><br><span class="line">        <span class="comment">// 发送数据</span></span><br><span class="line">        val out: OutputStream = client.getOutputStream</span><br><span class="line">        val objOut: ObjectOutputStream = <span class="keyword">new</span> ObjectOutputStream(out)</span><br><span class="line">        val task = <span class="keyword">new</span> Task()</span><br><span class="line">        objOut.writeObject(task)</span><br><span class="line">        print(<span class="string">&quot;发送task&quot;</span>)</span><br><span class="line">        objOut.flush()</span><br><span class="line">        objOut.close()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 关闭连接</span></span><br><span class="line">        client.close()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.Executor端代码，executor类似服务端</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.study.bigdata.spark.core.commu</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.&#123;InputStream, ObjectInputStream&#125;</span><br><span class="line"><span class="keyword">import</span> java.net.&#123;ServerSocket, Socket&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 演示driver提交任务到Executor</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">object Executor &#123;</span><br><span class="line">    <span class="function">def <span class="title">main</span><span class="params">(args: Array[String])</span>: Unit </span>= &#123;</span><br><span class="line">        <span class="comment">// 启动服务</span></span><br><span class="line">        val server = <span class="keyword">new</span> ServerSocket(<span class="number">9999</span>)</span><br><span class="line">        println(<span class="string">&quot;服务器启动，等待接受数据……&quot;</span>)</span><br><span class="line">        <span class="comment">// 等待客户端连接</span></span><br><span class="line">        val client: Socket = server.accept()</span><br><span class="line">        <span class="comment">// 接受数据</span></span><br><span class="line">        val in: InputStream = client.getInputStream</span><br><span class="line">        val inObj: ObjectInputStream = <span class="keyword">new</span> ObjectInputStream(in)</span><br><span class="line">        <span class="comment">// 读取数据</span></span><br><span class="line">        val task: Task = inObj.readObject().asInstanceOf[Task]</span><br><span class="line">        val res:List[Int] = task.compute()</span><br><span class="line">        println(<span class="string">&quot;接受客户端数据：&quot;</span> + res)</span><br><span class="line">        <span class="comment">// 关闭连接</span></span><br><span class="line">        inObj.close()</span><br><span class="line">        in.close()</span><br><span class="line">        client.close()</span><br><span class="line">        server.close()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3.driver向executor提交的逻辑任务task</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.study.bigdata.spark.core.commu</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 需要发送的类（逻辑，告诉executor怎么处理对应的数据）</span></span><br><span class="line"><span class="comment"> * 因为涉及到网络传输所以得继承序列化类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Task</span> <span class="keyword">extends</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    val data = List(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">    val logic: (Int) =&gt; Int = _ * <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    <span class="function">def <span class="title">compute</span><span class="params">()</span>: List[Int] </span>= &#123;</span><br><span class="line">        data.map(logic)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4.先启动executor，后启动driver，结果如下</p>
<img src="https://s2.loli.net/2022/03/20/nplXSCagtjx6bOd.png" alt="image.png" style="zoom:50%;" />

<img src="https://s2.loli.net/2022/03/20/mqcELGIPyst56gk.png" alt="image.png" style="zoom: 33%;" />
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous is-invisible is-hidden-mobile"><a href="/page/0/">上一页</a></div><div class="pagination-next"><a href="/page/2/">下一页</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link is-current" href="/">1</a></li><li><a class="pagination-link" href="/page/2/">2</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/mylogo.png" alt="相信未来"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">相信未来</p><p class="is-size-6 is-block">世界上只有一种真正的英雄主义，就是认清了生活的真相后还依然热爱它</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>陕西 榆林</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">15</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">9</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/ppoffice" target="_blank" rel="noopener">关注我</a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://hexo.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Hexo</span></span><span class="level-right"><span class="level-item tag">hexo.io</span></span></a></li><li><a class="level is-mobile" href="https://bulma.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bulma</span></span><span class="level-right"><span class="level-item tag">bulma.io</span></span></a></li></ul></div></div></div><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2024-07-16T14:05:51.000Z">2024-07-16</time></p><p class="title"><a href="/2024/07/16/%E5%8E%86%E5%8F%B2%E7%9A%84%E5%9E%83%E5%9C%BE%E6%97%B6%E9%97%B4/">历史的垃圾时间</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-01-04T12:09:54.000Z">2023-01-04</time></p><p class="title"><a href="/2023/01/04/%E4%BD%A0%E6%98%AF%E7%AC%AC%E5%87%A0%E6%B5%81%E4%BA%BA%E6%89%8D-%E8%B0%A2%E6%98%A5%E9%9C%96/">你是第几流人才-谢春霖</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-09-03T14:56:56.000Z">2022-09-03</time></p><p class="title"><a href="/2022/09/03/Flink-DataStream-API%E5%AD%A6%E4%B9%A0/">Flink DataStream API学习</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-08-30T14:03:15.000Z">2022-08-30</time></p><p class="title"><a href="/2022/08/30/flink%E9%87%8D%E8%A6%81%E6%A6%82%E5%BF%B5/">flink重要概念</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-08-29T14:54:07.000Z">2022-08-29</time></p><p class="title"><a href="/2022/08/29/%E5%8D%95%E6%9C%BA%E7%89%88flink%E6%8E%A5%E6%94%B6kafka%E6%B6%88%E6%81%AF/">单机版flink接收kafka消息</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2024/07/"><span class="level-start"><span class="level-item">七月 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/01/"><span class="level-start"><span class="level-item">一月 2023</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/09/"><span class="level-start"><span class="level-item">九月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/08/"><span class="level-start"><span class="level-item">八月 2022</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/07/"><span class="level-start"><span class="level-item">七月 2022</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/03/"><span class="level-start"><span class="level-item">三月 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/02/"><span class="level-start"><span class="level-item">二月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/12/"><span class="level-start"><span class="level-item">十二月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/11/"><span class="level-start"><span class="level-item">十一月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Hadoop/"><span class="tag">Hadoop</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/flink/"><span class="tag">flink</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/icarus/"><span class="tag">icarus</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/join/"><span class="tag">join</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/spark/"><span class="tag">spark</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/udf/"><span class="tag">udf</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E4%BA%BA%E6%96%87/"><span class="tag">人文</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%91%98%E6%8A%84/"><span class="tag">摘抄</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%95%B0%E4%BB%93/"><span class="tag">数仓</span><span class="tag">1</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">qcg Blog</a><p class="is-size-7"><span>&copy; 2024 quchengguo</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><!--!--></body></html>